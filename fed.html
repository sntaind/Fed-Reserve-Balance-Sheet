<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fed Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="stylesheet" href="shared/common.css">
<style>
.font-sm { --font-size: 13px; }
.font-md { --font-size: 15px; }
.font-lg { --font-size: 17px; }
.font-xl { --font-size: 19px; }

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

.dash { padding: 20px; max-width: 1400px; margin: 0 auto; }
.hd { padding: 12px 20px; margin: -20px -20px 25px -20px; background: #2a2a25; }
.dark .hd { background: #1a1a18; }
.hd-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
.hd-left { display: flex; align-items: center; gap: 12px; }
.hd h1 { font-family: var(--font-text); font-size: 1.1rem; color: #fff; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0; }
.dark .hd h1 { color: #e8e6d6; }
.hd-title-kr { font-size: 0.85rem; color: rgba(255,255,255,0.6); font-weight: 400; margin-left: 8px; }
.hd-btns { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.hd .btn { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.25); padding: 0; width: 32px; height: 32px; font-family: inherit; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.hd .btn:hover { background: rgba(255,255,255,0.25); }
.hd .btn.primary { background: #3b82f6; border-color: #3b82f6; width: auto; padding: 0 12px; gap: 6px; }
.hd .btn.primary:hover { background: #2563eb; }
.hd .btn svg { width: 16px; height: 16px; }
.hd .btn.with-text { width: auto; padding: 0 12px; gap: 6px; }
.pdf-btn { display: flex; align-items: center; justify-content: center; gap: 6px; background: #22c55e; color: #000; border: none; height: 32px; padding: 0 12px; font-family: inherit; font-size: 0.8em; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
.pdf-btn:hover { filter: brightness(1.1); }
.pdf-btn svg { width: 14px; height: 14px; }
.pdf-btn input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.rel-info { display: flex; gap: 16px; font-size: 0.8em; color: rgba(255,255,255,0.7); margin-top: 8px; flex-wrap: wrap; align-items: center; font-weight: 400; }
.rel-info strong { color: #fff; font-family: var(--font-mono); font-weight: var(--font-mono-weight); }
.status { display: flex; align-items: center; gap: 6px; font-size: 0.8em; color: rgba(255,255,255,0.6); }
.status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; }

.tabs { display: flex; gap: 1px; background: var(--border); overflow-x: auto; margin-bottom: 20px; }
.tab { flex: 1; min-width: 80px; background: var(--bg2); color: var(--text2); border: none; padding: 12px 10px; cursor: pointer; font-family: inherit; font-size: 0.85em; font-weight: 600; white-space: nowrap; transition: all 0.2s; }
.tab:hover { background: var(--bg3); color: var(--text); }
.tab.active { background: var(--accent); color: var(--bg); }

.tab-content { display: none; }
.tab-content.active { display: block; }

.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
.card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; }
.card-hd { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.card-kr { font-size: 1.1em; color: var(--accent); font-weight: 700; }
.card-en { font-size: 0.8em; color: var(--text3); font-weight: 500; }
.card-val { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 1.6em; color: var(--text); margin-bottom: 6px; }
.card-desc { font-size: 0.85em; color: var(--text3); margin-bottom: 12px; }
.badges { display: flex; gap: 8px; flex-wrap: wrap; }
.badge { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 0.85em; padding: 4px 10px; background: var(--bg3); border: 1px solid var(--border); }
.badge.pos { color: var(--pos); border-color: var(--pos); }
.badge.neg { color: var(--neg); border-color: var(--neg); }

.box { background: var(--bg2); border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; }
.box h3 { font-size: 1.1em; color: var(--accent); margin-bottom: 16px; font-weight: 700; }
.bar-grp { margin: 16px 0; }
.bar-lbl { display: flex; justify-content: space-between; font-size: 0.95em; margin-bottom: 8px; font-weight: 500; }
.sbar { display: flex; height: 28px; background: var(--bg3); border: 1px solid var(--border); overflow: hidden; }
.seg { height: 100%; transition: width 0.5s; }
.seg.tsy { background: var(--primary); }
.seg.mbs { background: var(--secondary); }
.seg.oth { background: var(--text3); }
.leg { display: flex; gap: 20px; margin-top: 10px; font-size: 0.85em; font-weight: 500; }
.dot { display: inline-block; width: 12px; height: 12px; margin-right: 6px; vertical-align: middle; }
.dot.tsy { background: var(--primary); }
.dot.mbs { background: var(--secondary); }
.dot.oth { background: var(--text3); }

.info { background: var(--bg2); border: 1px solid var(--border); padding: 20px; }
.info h4 { font-size: 1em; color: var(--accent); margin-bottom: 14px; font-weight: 700; }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
.info-item strong { display: block; color: var(--text); font-weight: 600; margin-bottom: 4px; }
.info-item p { font-size: 0.9em; color: var(--text2); line-height: 1.5; }

.tbl-box { background: var(--bg2); border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; overflow-x: auto; }
.tbl-box h3 { font-size: 1.1em; color: var(--accent); margin-bottom: 6px; font-weight: 700; }
.tbl-sub { font-size: 0.85em; color: var(--text3); margin-bottom: 16px; }
table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
th { background: var(--bg3); font-weight: 600; color: var(--text2); }
td.val { font-family: var(--font-mono); font-weight: var(--font-mono-weight); text-align: right; }
td.chg { font-family: var(--font-mono); font-weight: var(--font-mono-weight); text-align: right; }
td.chg small { color: var(--text3); font-size: 0.85em; }
td.chg.pos { color: var(--pos); }
td.chg.neg { color: var(--neg); }
.bil { display: flex; flex-direction: column; gap: 2px; }
.bil .kr { font-weight: 600; color: var(--text); }
.bil .en { font-size: 0.8em; color: var(--text3); }
tr.l1 td:first-child .bil { padding-left: 16px; }
tr.l2 td:first-child .bil { padding-left: 32px; }
tr.sec-hd td { background: var(--bg3); font-weight: 700; color: var(--accent); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
tr.tot td { background: var(--bg3); font-weight: 700; }
tr.hi td { background: rgba(91, 123, 139, 0.15); font-weight: 700; }

.mat-chart { display: flex; justify-content: space-around; align-items: flex-end; gap: 12px; padding: 20px 0; margin-top: 20px; border-top: 1px solid var(--border); }
.mat-col { text-align: center; flex: 1; }
.mat-bar-wrap { height: 150px; display: flex; align-items: flex-end; justify-content: center; }
.mat-bar { width: 40px; background: linear-gradient(to top, var(--primary), var(--secondary)); border-radius: 4px 4px 0 0; min-height: 5px; transition: height 0.5s; }
.mat-lbl { font-size: 0.8em; color: var(--text2); margin-top: 8px; font-weight: 500; }
.mat-val { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 0.85em; color: var(--text); margin-top: 4px; }

.stmt-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
.stmt-sec h4 { font-size: 1em; color: var(--accent); margin-bottom: 12px; font-weight: 700; }

.summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px; }
.summary-row .card { background: var(--bg3); }

.bk-tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.bk-tab { background: var(--bg3); border: 1px solid var(--border); padding: 10px 14px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; flex-direction: column; gap: 2px; min-width: 100px; }
.bk-tab:hover { border-color: var(--border2); background: var(--bg); }
.bk-tab.active { background: var(--accent); border-color: var(--accent); }
.bk-tab.active .bk-tab-name, .bk-tab.active .bk-tab-val, .bk-tab.active .bk-tab-pct { color: var(--bg); }
.bk-tab-name { font-weight: 600; font-size: 0.9em; color: var(--text); }
.bk-tab-val { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 0.85em; color: var(--text); }
.bk-tab-pct { font-size: 0.75em; color: var(--text3); }
.bk-detail-panel { }
.bk-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
.bk-detail-name { }
.bk-detail-kr { font-size: 1.3em; font-weight: 700; color: var(--accent); display: block; }
.bk-detail-en { font-size: 0.9em; color: var(--text3); }
.bk-detail-total { text-align: right; }
.bk-detail-total-val { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 1.5em; color: var(--text); display: block; }
.bk-detail-total-pct { font-size: 0.85em; color: var(--text2); }
.bk-detail-chg { font-family: var(--font-mono); font-weight: var(--font-mono-weight); font-size: 0.85em; display: block; margin-top: 4px; }
.bk-detail-chg.pos { color: var(--pos); }
.bk-detail-chg.neg { color: var(--neg); }
.bk-detail-empty { padding: 40px; text-align: center; color: var(--text3); }

.chart-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
.chart-controls label { font-weight: 600; color: var(--text2); }
.period-btn { background: var(--bg3); border: 1px solid var(--border); padding: 8px 16px; cursor: pointer; font-family: inherit; font-weight: 600; color: var(--text2); transition: all 0.2s; }
.period-btn:hover { background: var(--border); color: var(--text); }
.period-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
.chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; }
.chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; }
.chart-card h4 { font-size: 1.1em; color: var(--accent); font-weight: 700; }
.chart-card .sub { font-size: 0.85em; color: var(--text3); margin-bottom: 12px; }
.chart-stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.chart-stat .label { font-size: 0.8em; color: var(--text3); }
.chart-stat .value { font-family: var(--font-mono); font-weight: var(--font-mono-weight); color: var(--text); }
.chart-stat .change { font-family: var(--font-mono); font-weight: var(--font-mono-weight); }
.chart-stat .change.pos { color: var(--pos); }
.chart-stat .change.neg { color: var(--neg); }
.chart-svg { width: 100%; height: auto; }
.chart-line { fill: none; stroke: var(--primary); stroke-width: 2; }
.chart-area { fill: rgba(91, 123, 139, 0.15); }
.chart-dot { fill: var(--primary); }
.chart-grid-line { stroke: var(--border); stroke-dasharray: 2; }
.chart-label { font-size: 10px; fill: var(--text3); }
.no-data { text-align: center; padding: 60px 20px; color: var(--text2); }
.no-data h3 { margin-bottom: 10px; }

.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
.modal.open { display: block; }
.modal-content { background: var(--bg2); border: 1px solid #2a2a25; padding: 24px; max-width: 500px; width: 90vw; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.modal-content h3 { font-size: 1.2em; color: var(--accent); margin-bottom: 16px; font-weight: 700; }
.form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.saved-list { max-height: 300px; overflow-y: auto; }
.saved-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
.saved-item:hover { background: var(--bg3); }
.saved-date { font-weight: 600; color: var(--text); }
.saved-val { font-size: 0.85em; color: var(--text2); font-family: var(--font-mono); font-weight: var(--font-mono-weight); }
.btn-sm { padding: 6px 12px; font-size: 0.85em; }
.btn-danger { background: var(--neg); color: #fff; border-color: var(--neg); }
.btn-danger:hover { filter: brightness(1.1); background: var(--neg); }

.setting-group { margin-bottom: 20px; }
.setting-group label { display: block; font-weight: 600; color: var(--text2); margin-bottom: 10px; font-size: 0.9em; }
.setting-row { display: flex; flex-wrap: wrap; gap: 8px; }
.setting-btn { background: var(--bg3); border: 1px solid var(--border); padding: 10px 16px; cursor: pointer; font-family: inherit; font-weight: 500; color: var(--text2); transition: all 0.2s; font-size: 0.9em; }
.setting-btn:hover { background: var(--border); color: var(--text); }
.setting-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }

.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: var(--bg); padding: 14px 24px; font-weight: 600; z-index: 2000; opacity: 0; transition: all 0.3s; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.error { background: var(--neg); color: #fff; }

.loading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; }
.loading.show { display: flex; }
.spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.dropzone-initial { border: 2px dashed var(--border2); padding: 60px 40px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg2); margin-bottom: 20px; }
.dropzone-initial:hover, .dropzone-initial.dragover { border-color: var(--accent); background: var(--bg3); }
.dropzone-initial h2 { font-size: 1.3em; color: var(--accent); margin-bottom: 12px; }
.dropzone-initial p { color: var(--text2); margin-bottom: 8px; }
.dropzone-initial a { color: var(--pos); }
.dropzone-initial input { display: none; }

.nav-arrows { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 100; }
.nav-btn { width: 44px; height: 44px; background: var(--bg2); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text); }
.nav-btn:hover { background: var(--bg3); }
.nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.nav-btn svg { width: 20px; height: 20px; }

@media (max-width: 768px) {
  .dash { padding: 12px; }
  .hd { padding-bottom: 14px; margin-bottom: 16px; }
  .hd-top { flex-direction: column; gap: 10px; }
  .hd h1 { font-size: 1.2em; }
  .hd .sub-kr { font-size: 0.95em; }
  .hd .sub-en { font-size: 0.8em; }
  .hd-btns { width: 100%; flex-wrap: wrap; gap: 6px; }
  .hd-btns .btn, .hd-btns .pdf-btn { font-size: 0.8em; padding: 8px 10px; flex: 1; min-width: 80px; justify-content: center; }
  .rel-info { font-size: 0.85em; gap: 12px; }
  .tabs { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 0; }
  .tab { min-width: 60px; padding: 10px 8px; font-size: 0.7em; }
  .grid { grid-template-columns: 1fr; gap: 12px; }
  .card { padding: 14px; }
  .card-kr { font-size: 1em; }
  .card-val { font-size: 1.3em; }
  .card-desc { font-size: 0.8em; }
  .badges { gap: 5px; }
  .badge { font-size: 0.75em; padding: 3px 7px; }
  .box { padding: 14px; margin-bottom: 16px; }
  .box h3 { font-size: 1em; margin-bottom: 12px; }
  .tbl-box { padding: 10px; margin-bottom: 16px; }
  .tbl-box h3 { font-size: 0.95em; }
  .tbl-sub { font-size: 0.75em; margin-bottom: 10px; }
  table { font-size: 0.75em; min-width: 400px; }
  th, td { padding: 6px 4px; }
  th { font-size: 0.7em; }
  .bil .kr { font-size: 0.85em; }
  .bil .en { font-size: 0.65em; }
  .stmt-grid { grid-template-columns: 1fr; gap: 16px; }
  .stmt-sec { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .stmt-sec h4 { font-size: 0.9em; margin-bottom: 10px; }
  .stmt-sec table { min-width: 350px; }
  .summary-row { grid-template-columns: 1fr; gap: 10px; margin-top: 16px; }
  .summary-row .card { padding: 12px; }
  .summary-row .card-val { font-size: 1.2em; }
  .chart-grid { grid-template-columns: 1fr; }
  .info-grid { grid-template-columns: 1fr; gap: 12px; }
  .mat-chart { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 12px 0; }
  .mat-col { min-width: unset; }
  .mat-bar-wrap { height: 80px; }
  .mat-bar { width: 24px; }
  .mat-lbl { font-size: 0.6em; }
  .mat-val { font-size: 0.65em; }
  .leg { flex-wrap: wrap; gap: 10px; font-size: 0.8em; }
  .bar-lbl { font-size: 0.85em; }
  .sbar { height: 24px; }
  .formula { font-size: 0.85em; padding: 12px; }
  .formula-calc { font-size: 0.85em; }
  .dropzone-initial { padding: 30px 15px; }
  .dropzone-initial h2 { font-size: 1em; }
  .dropzone-initial p { font-size: 0.85em; }
  .chat-w { bottom: 10px; right: 10px; }
  .chat-tog { width: 44px; height: 44px; font-size: 18px; }
  .chat-cont { width: 100%; max-width: 100%; height: 70vh; }
  .modal-content { width: 95%; max-height: 85vh; }
  .modal-content h2 { font-size: 1.1em; }
  .nav-arrows { right: 8px; bottom: 70px; }
  .nav-btn { width: 36px; height: 36px; }
  .info { padding: 12px; }
  .info h4 { font-size: 0.9em; }
  .info-item p { font-size: 0.8em; }
  .bk-tabs { gap: 4px; overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; padding-bottom: 12px; }
  .bk-tab { min-width: 80px; padding: 8px 10px; flex-shrink: 0; }
  .bk-tab-name { font-size: 0.8em; }
  .bk-tab-val { font-size: 0.75em; }
  .bk-tab-pct { font-size: 0.65em; }
  .bk-detail-header { flex-direction: column; gap: 8px; }
  .bk-detail-total { text-align: left; }
  .bk-detail-kr { font-size: 1.1em; }
  .bk-detail-total-val { font-size: 1.2em; }
}

/* í…Œì´ë¸” ìŠ¤í¬ë¡¤ íŒíŠ¸ */
.tbl-box::after {
  content: 'â† ìŠ¤í¬ë¡¤ â†’';
  display: none;
  text-align: center;
  font-size: 0.7em;
  color: var(--text3);
  padding-top: 8px;
}
@media (max-width: 768px) {
  .tbl-box::after { display: block; }
}

/* ìƒì„¸/ì¶•ì•½ í† ê¸€ */
.view-toggle {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}
.toggle-btn {
  background: var(--bg2);
  color: var(--text2);
  border: 1px solid var(--border);
  padding: 6px 16px;
  font-family: inherit;
  font-size: 0.85em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.toggle-btn:first-child { border-radius: 4px 0 0 4px; }
.toggle-btn:last-child { border-radius: 0 4px 4px 0; }
.toggle-btn:hover { background: var(--bg3); }
.toggle-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="nav-arrows" id="navArrows" style="display:none">
  <button class="nav-btn" id="navPrev" onclick="navData(-1)" title="ì´ì „ ë³´ê³ ì„œ">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
  </button>
  <button class="nav-btn" id="navNext" onclick="navData(1)" title="ë‹¤ìŒ ë³´ê³ ì„œ">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
  </button>
</div>

<div class="dash">
  <div class="hd">
    <div class="hd-top">
      <div class="hd-left">
        <a href="index.html" class="btn" title="í™ˆ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </a>
        <h1>Fed Dashboard</h1>
        <span class="hd-title-kr">ì—°ì¤€ ëŒ€ì°¨ëŒ€ì¡°í‘œ</span>
      </div>
      <div class="hd-btns">
        <label class="pdf-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>PDF<input type="file" id="pdfInput" accept=".pdf" multiple></label>
        <a class="btn primary" href="https://www.federalreserve.gov/releases/h41/" target="_blank" title="ì—°ì¤€ H.4.1 í˜ì´ì§€" style="text-decoration:none"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> ìµœì‹  ë°ì´í„°</a>
        <button class="btn" onclick="openModal('historyModal')" title="ì €ì¥ëœ ë°ì´í„°"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></button>
        <button class="btn" onclick="toggleTheme()" title="í…Œë§ˆ ë³€ê²½"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button>
        <button class="btn" onclick="openModal('settingsModal')" title="ì„¤ì •"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      </div>
    </div>
    <div class="rel-info">
      <span>ë°œí‘œì¼: <strong id="releaseDate">-</strong></span>
      <span>ê¸°ì¤€ì¼: <strong id="asOfDate">-</strong></span>
      <span class="status"><span class="status-dot"></span> <span id="statusText">ëŒ€ê¸°</span></span>
      <span style="margin-left:auto;opacity:0.5;font-size:0.75em" id="appVersion"></span>
    </div>
  </div>

  <div class="dropzone-initial" id="dropzoneInitial">
    <h2><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:8px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>H.4.1 PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h2>
    <p>ì—¬ëŸ¬ íŒŒì¼ì„ í•œë²ˆì— ì˜¬ë ¤ì„œ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ìŒ“ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    <p><a href="https://www.federalreserve.gov/releases/h41/" target="_blank">ì—°ì¤€ H.4.1 PDF ë‹¤ìš´ë¡œë“œ â†’</a></p>
    <input type="file" id="pdfInputInitial" accept=".pdf" multiple>
  </div>

  <div class="tabs" id="tabsContainer" style="display:none">
    <button class="tab active" onclick="showTab('overview',this)">ê°œìš”</button>
    <button class="tab" onclick="showTab('factors',this)">ì¤€ë¹„ê¸ˆ ìš”ì¸</button>
    <button class="tab" onclick="showTab('factorsSummary',this)">ê¸°ë¡ í•­ëª©</button>
    <button class="tab" onclick="showTab('maturity',this)">ë§Œê¸° ë¶„í¬</button>
    <button class="tab" onclick="showTab('loans',this)">ëŒ€ì¶œ/ì¦ê¶Œ</button>
    <button class="tab" onclick="showTab('consolidated',this)">ì¬ë¬´ì œí‘œ</button>
    <button class="tab" onclick="showTab('banks',this)">ì§€ì—­ ì—°ì¤€</button>
    <button class="tab" onclick="showTab('frNotes',this)">ì—°ë°©ì¤€ë¹„ê¶Œ</button>
    <button class="tab" onclick="showTab('charts',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>ì¶”ì´</button>
  </div>

  <div id="overview" class="tab-content"></div>
  <div id="factors" class="tab-content"></div>
  <div id="factorsSummary" class="tab-content"></div>
  <div id="maturity" class="tab-content"></div>
  <div id="loans" class="tab-content"></div>
  <div id="consolidated" class="tab-content"></div>
  <div id="banks" class="tab-content"></div>
  <div id="frNotes" class="tab-content"></div>
  <div id="charts" class="tab-content"></div>
</div>

<div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>ì €ì¥ëœ ë°ì´í„° <span id="dataCount" style="font-size:0.7em;color:var(--text2)"></span></h3>
    <div id="savedDataList" class="saved-list"></div>
    <div class="form-actions">
      <button class="btn btn-danger" onclick="deleteAllData()" id="deleteAllBtn" style="display:none">ëª¨ë‘ ì‚­ì œ</button>
      <button class="btn" onclick="closeModal('historyModal')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>ì„¤ì •</h3>
    <div class="setting-group">
      <label>í…Œë§ˆ</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setTheme('dark')" id="themeDark">ğŸŒ™ ë‹¤í¬</button>
        <button class="setting-btn" onclick="setTheme('light')" id="themeLight">â˜€ï¸ ë¼ì´íŠ¸</button>
      </div>
    </div>
    <div class="setting-group">
      <label>ê¸€ì í¬ê¸°</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setFontSize('sm')" id="fontSm">ì‘ê²Œ</button>
        <button class="setting-btn" onclick="setFontSize('md')" id="fontMd">ë³´í†µ</button>
        <button class="setting-btn" onclick="setFontSize('lg')" id="fontLg">í¬ê²Œ</button>
        <button class="setting-btn" onclick="setFontSize('xl')" id="fontXl">ì•„ì£¼ í¬ê²Œ</button>
      </div>
    </div>
    <div class="setting-group">
      <label>ë³¸ë¬¸ ì„œì²´</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setTextFont('pressura')" id="textPressura">GT Pressura</button>
        <button class="setting-btn" onclick="setTextFont('noto')" id="textNoto">Noto Sans KR</button>
        <button class="setting-btn" onclick="setTextFont('pretendard')" id="textPretendard">Pretendard</button>
      </div>
    </div>
    <div class="setting-group">
      <label>ë³¸ë¬¸ ë‘ê»˜</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setTextWeight('regular')" id="textWeightRegular">Regular</button>
        <button class="setting-btn" onclick="setTextWeight('text')" id="textWeightText">Text</button>
        <button class="setting-btn" onclick="setTextWeight('medium')" id="textWeightMedium">Medium</button>
        <button class="setting-btn" onclick="setTextWeight('semibold')" id="textWeightSemibold">SemiBold</button>
        <button class="setting-btn" onclick="setTextWeight('bold')" id="textWeightBold">Bold</button>
        <button class="setting-btn" onclick="setTextWeight('extrabold')" id="textWeightExtrabold">ExtraBold</button>
        <button class="setting-btn" onclick="setTextWeight('heavy')" id="textWeightHeavy">Heavy</button>
      </div>
    </div>
    <div class="setting-group">
      <label>ìˆ«ì ì„œì²´</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setMonoFont('pressura-mono')" id="monoPressura">GT Pressura Mono</button>
        <button class="setting-btn" onclick="setMonoFont('ibm')" id="monoIbm">IBM Plex Mono</button>
        <button class="setting-btn" onclick="setMonoFont('source')" id="monoSource">Source Code Pro</button>
      </div>
    </div>
    <div class="setting-group">
      <label>ìˆ«ì ë‘ê»˜</label>
      <div class="setting-row">
        <button class="setting-btn" onclick="setMonoWeight('light')" id="monoWeightLight">Light</button>
        <button class="setting-btn" onclick="setMonoWeight('regular')" id="monoWeightRegular">Regular</button>
        <button class="setting-btn" onclick="setMonoWeight('text')" id="monoWeightText">Text</button>
        <button class="setting-btn" onclick="setMonoWeight('medium')" id="monoWeightMedium">Medium</button>
        <button class="setting-btn" onclick="setMonoWeight('bold')" id="monoWeightBold">Bold</button>
      </div>
    </div>
    <div class="form-actions"><button class="btn primary" onclick="closeModal('settingsModal')">ë‹«ê¸°</button></div>
  </div>
</div>

<script src="shared/icons.js"></script>
<script>
// í™ˆ ì•„ì´ì½˜ ì‚½ì…
document.getElementById('homeIcon').innerHTML = Icons.home;
</script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ========== ë²„ì „ ì²´í¬ ì‹œìŠ¤í…œ ==========
const APP_VERSION = 'v4.1.0';
const VERSION_URL = 'https://raw.githubusercontent.com/sntaind/Fed-Reserve-Balance-Sheet/main/version.json';

async function checkForUpdates() {
  try {
    const res = await fetch(VERSION_URL + '?t=' + Date.now());
    if (!res.ok) return;
    const data = await res.json();
    if (data.version && data.version !== APP_VERSION) {
      if (confirm(`ğŸ†• ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤!\n\ní˜„ì¬: ${APP_VERSION}\nìµœì‹ : ${data.version}\n\në‹¤ìš´ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?`)) {
        window.open(data.downloadUrl || 'https://github.com/sntaind/Fed-Reserve-Balance-Sheet/releases', '_blank');
      }
    }
  } catch (e) { console.log('Version check skipped'); }
}

// ë²„ì „ í‘œì‹œ ë° ì²´í¬
document.addEventListener('DOMContentLoaded', () => {
  const v = document.getElementById('appVersion');
  if (v) v.textContent = APP_VERSION;
  setTimeout(checkForUpdates, 2000);
});

// ========== ì•± ì„¤ì • ==========
const API_BASE = '';
let currentData = null;
let savedDataList = [];
let chartPeriod = '3m';
const defaultSettings = {theme:'light',fontSize:'md',textFont:'pressura',monoFont:'pressura-mono',textWeight:'medium',monoWeight:'medium'};
let settings = {...defaultSettings};
const fontMap = {
  text: { 
    pressura: "'GT Pressura', 'SUIT', -apple-system, 'Apple SD Gothic Neo', sans-serif",
    noto: "'Noto Sans KR', sans-serif", 
    pretendard: "'Pretendard', sans-serif"
  },
  mono: { 
    'pressura-mono': "'GT Pressura Mono', 'Source Code Pro', monospace",
    ibm: "'IBM Plex Mono', monospace", 
    source: "'Source Code Pro', monospace"
  }
};

function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.classList.remove('show'), 2500);
}

async function saveDataToServer() {
  try {
    await fetch(API_BASE + '/api/data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(savedDataList) });
    updateStatus('ì €ì¥ë¨');
  } catch (e) { console.error('Save error:', e); }
}

async function loadDataFromServer() {
  try {
    const res = await fetch(API_BASE + '/api/data');
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      savedDataList = data;
      currentDataIndex = 0;
      currentData = savedDataList[0];
      renderAll();
      document.getElementById('dropzoneInitial').style.display = 'none';
      document.getElementById('tabsContainer').style.display = 'flex';
      document.getElementById('overview').classList.add('active');
      updateNavButtons();
    }
  } catch (e) { console.error('Load error:', e); }
}

async function saveSettingsToServer() {
  try { await fetch(API_BASE + '/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) }); } catch (e) { console.error('Settings save error:', e); }
}

async function loadSettingsFromServer() {
  try {
    const res = await fetch(API_BASE + '/api/settings');
    const data = await res.json();
    if (data && Object.keys(data).length > 0) settings = {...defaultSettings, ...data};
    applySettings();
  } catch (e) { console.error('Settings load error:', e); }
}

function updateStatus(text) {
  document.getElementById('statusText').textContent = text;
  setTimeout(() => { document.getElementById('statusText').textContent = 'ëŒ€ê¸°'; }, 2000);
}

function applySettings() {
  document.body.classList.remove('dark', 'font-sm', 'font-md', 'font-lg', 'font-xl');
  if (settings.theme === 'dark') document.body.classList.add('dark');
  document.body.classList.add('font-' + settings.fontSize);
  document.documentElement.style.setProperty('--font-text', fontMap.text[settings.textFont] || fontMap.text.pressura);
  document.documentElement.style.setProperty('--font-mono', fontMap.mono[settings.monoFont] || fontMap.mono['pressura-mono']);
  // ì›¨ì´íŠ¸ ì´ë¦„â†’ìˆ«ì ë§¤í•‘
  const weightMap = { light: '300', regular: '400', text: '450', medium: '500', semibold: '600', bold: '700', extrabold: '800', heavy: '900' };
  const textWeightName = settings.textWeight || 'medium';
  const monoWeightName = settings.monoWeight || 'medium';
  const textWeight = weightMap[textWeightName] || '500';
  const monoWeight = weightMap[monoWeightName] || '500';
  document.body.style.fontWeight = textWeight;
  document.documentElement.style.setProperty('--font-text-weight', textWeight);
  document.documentElement.style.setProperty('--font-mono-weight', monoWeight);
  // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
  document.querySelectorAll('.setting-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('theme' + (settings.theme === 'dark' ? 'Dark' : 'Light'))?.classList.add('active');
  document.getElementById('font' + settings.fontSize.charAt(0).toUpperCase() + settings.fontSize.slice(1))?.classList.add('active');
  // ë³¸ë¬¸ ì„œì²´ í™œì„±í™”
  if (settings.textFont === 'pressura') document.getElementById('textPressura')?.classList.add('active');
  else if (settings.textFont === 'noto') document.getElementById('textNoto')?.classList.add('active');
  else if (settings.textFont === 'pretendard') document.getElementById('textPretendard')?.classList.add('active');
  // ë³¸ë¬¸ ë‘ê»˜ í™œì„±í™”
  document.getElementById('textWeight' + textWeightName.charAt(0).toUpperCase() + textWeightName.slice(1))?.classList.add('active');
  // ìˆ«ì ì„œì²´ í™œì„±í™”
  if (settings.monoFont === 'pressura-mono') document.getElementById('monoPressura')?.classList.add('active');
  else if (settings.monoFont === 'ibm') document.getElementById('monoIbm')?.classList.add('active');
  else if (settings.monoFont === 'source') document.getElementById('monoSource')?.classList.add('active');
  // ìˆ«ì ë‘ê»˜ í™œì„±í™”
  document.getElementById('monoWeight' + monoWeightName.charAt(0).toUpperCase() + monoWeightName.slice(1))?.classList.add('active');
}

function setTheme(t) { settings.theme = t; saveSettingsToServer(); applySettings(); }
function setFontSize(s) { settings.fontSize = s; saveSettingsToServer(); applySettings(); }
function setTextFont(f) { settings.textFont = f; saveSettingsToServer(); applySettings(); }
function setMonoFont(f) { settings.monoFont = f; saveSettingsToServer(); applySettings(); }
function setTextWeight(w) { settings.textWeight = w; saveSettingsToServer(); applySettings(); }
function setMonoWeight(w) { settings.monoWeight = w; saveSettingsToServer(); applySettings(); }

const dropzone = document.getElementById('dropzoneInitial');
const pdfInput = document.getElementById('pdfInput');
const pdfInputInitial = document.getElementById('pdfInputInitial');

dropzone.addEventListener('click', () => pdfInputInitial.click());
dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', (e) => { 
  e.preventDefault(); 
  dropzone.classList.remove('dragover'); 
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  if (files.length) processMultiplePDFs(files);
});
pdfInput.addEventListener('change', (e) => { 
  const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
  if (files.length) processMultiplePDFs(files);
  e.target.value = '';
});
pdfInputInitial.addEventListener('change', (e) => { 
  const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
  if (files.length) processMultiplePDFs(files);
  e.target.value = '';
});
document.body.addEventListener('dragover', (e) => e.preventDefault());
document.body.addEventListener('drop', (e) => { 
  e.preventDefault(); 
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  if (files.length) processMultiplePDFs(files);
});

async function processMultiplePDFs(files) {
  document.getElementById('loading').classList.add('show');
  let processed = 0;
  let errors = 0;
  
  for (const file of files) {
    try {
      await processSinglePDF(file);
      processed++;
    } catch (err) {
      console.error('PDF ì²˜ë¦¬ ì˜¤ë¥˜:', file.name, err);
      errors++;
    }
  }
  
  document.getElementById('loading').classList.remove('show');
  
  if (processed > 0) {
    // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ì´ ì•ìœ¼ë¡œ)
    savedDataList.sort((a, b) => {
      const dateA = new Date(a.releaseDate || '1900-01-01');
      const dateB = new Date(b.releaseDate || '1900-01-01');
      return dateB - dateA;
    });
    
    currentDataIndex = 0;
    currentData = savedDataList[0];
    saveDataToServer();
    renderAll();
    document.getElementById('dropzoneInitial').style.display = 'none';
    document.getElementById('tabsContainer').style.display = 'flex';
    updateNavButtons();
    
    if (errors > 0) {
      showToast(`âœ… ${processed}ê°œ ì™„ë£Œ, âš ï¸ ${errors}ê°œ ì‹¤íŒ¨`);
    } else {
      showToast(`âœ… ${processed}ê°œ PDF ë¶„ì„ ì™„ë£Œ`);
    }
  } else {
    showToast('âŒ PDF ì²˜ë¦¬ ì‹¤íŒ¨');
  }
}

async function processSinglePDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    fullText += textContent.items.map(item => item.str).join(' ') + '\n';
  }
  parseH41Text(fullText, true); // skipRender = true
}

function parseH41Text(text, skipRender = false) {
  const extractWithChanges = (label) => {
    // ë‘ ê°€ì§€ ê²½ìš° ëª¨ë‘ ì§€ì›:
    // 1) ë¼ë²¨ + ê°ì£¼ìˆ«ì + ê³µë°± + ê°’ (ì˜ˆ: "Bills2 248,755")
    // 2) ë¼ë²¨ + ì¶”ê°€ë¬¸ì + ê³µë°± + ê°’ (ì˜ˆ: "Reserve balances with Federal Reserve Banks 3,049,630")
    const patterns = [
      // íŒ¨í„´1a: ë¼ë²¨ + ê°ì£¼(0-2ìë¦¬) + ê³µë°± + ê°’ +/- ì£¼ê°„ +/- ì—°ê°„
      new RegExp(label + '\\d{0,2}\\s+([0-9,]+)\\s*([+-])\\s*([0-9,]+)\\s*([+-])\\s*([0-9,]+)', 'i'),
      // íŒ¨í„´1b: ë¼ë²¨ + ë¹„ìˆ«ìë¬¸ìë“¤ + ê³µë°± + ê°’ +/- ì£¼ê°„ +/- ì—°ê°„
      new RegExp(label + '[a-z\\s]*\\s+([0-9,]+)\\s*([+-])\\s*([0-9,]+)\\s*([+-])\\s*([0-9,]+)', 'i'),
      // íŒ¨í„´2a: ë¼ë²¨ + ê°ì£¼ + ê°’ 0 +/- ì—°ê°„
      new RegExp(label + '\\d{0,2}\\s+([0-9,]+)\\s+0\\s+([+-])\\s*([0-9,]+)', 'i'),
      // íŒ¨í„´2b: ë¼ë²¨ + ë¹„ìˆ«ìë¬¸ìë“¤ + ê°’ 0 +/- ì—°ê°„
      new RegExp(label + '[a-z\\s]*\\s+([0-9,]+)\\s+0\\s+([+-])\\s*([0-9,]+)', 'i'),
      // íŒ¨í„´3a: ë¼ë²¨ + ê°ì£¼ + ê°’ 0 0
      new RegExp(label + '\\d{0,2}\\s+([0-9,]+)\\s+0\\s+0', 'i'),
      // íŒ¨í„´3b: ë¼ë²¨ + ë¹„ìˆ«ìë¬¸ìë“¤ + ê°’ 0 0
      new RegExp(label + '[a-z\\s]*\\s+([0-9,]+)\\s+0\\s+0', 'i'),
      // íŒ¨í„´4: í´ë°± - ê°’ë§Œ
      new RegExp(label + '(?:\\d{0,2}|[a-z\\s]*)\\s+([0-9,]+)', 'i'),
    ];
    
    // íŒ¨í„´1 ì‹œë„ (ì£¼ê°„/ì—°ê°„ ë³€ë™ ìˆìŒ)
    for (let i = 0; i < 2; i++) {
      let m = text.match(patterns[i]);
      if (m && m[1]) {
        const v = parseInt(m[1].replace(/,/g, '')) || 0;
        let w = parseInt(m[3].replace(/,/g, '')) || 0;
        let y = parseInt(m[5].replace(/,/g, '')) || 0;
        if (m[2] === '-') w = -w;
        if (m[4] === '-') y = -y;
        return { v, w, y };
      }
    }
    
    // íŒ¨í„´2 ì‹œë„ (ì£¼ê°„ë³€ë™ 0)
    for (let i = 2; i < 4; i++) {
      let m = text.match(patterns[i]);
      if (m && m[1]) {
        const v = parseInt(m[1].replace(/,/g, '')) || 0;
        let y = parseInt(m[3].replace(/,/g, '')) || 0;
        if (m[2] === '-') y = -y;
        return { v, w: 0, y };
      }
    }
    
    // íŒ¨í„´3 ì‹œë„ (ë³€ë™ ì—†ìŒ)
    for (let i = 4; i < 6; i++) {
      let m = text.match(patterns[i]);
      if (m && m[1]) {
        const v = parseInt(m[1].replace(/,/g, '')) || 0;
        return { v, w: 0, y: 0 };
      }
    }
    
    // íŒ¨í„´4 í´ë°±
    let m = text.match(patterns[6]);
    if (m && m[1]) {
      const v = parseInt(m[1].replace(/,/g, '')) || 0;
      return { v, w: 0, y: 0 };
    }
    
    return { v: 0, w: 0, y: 0 };
  };

  const dateMatch = text.match(/(?:December|January|February|March|April|May|June|July|August|September|October|November)\s+\d{1,2},?\s*\d{4}/i);
  const weekMatch = text.match(/Week\s+ended\s+(\w+\s+\d{1,2},?\s*\d{4})/i);

  currentData = {
    releaseDate: dateMatch ? dateMatch[0] : 'Unknown',
    asOfDate: weekMatch ? weekMatch[1] : (dateMatch ? dateMatch[0] : 'Unknown'),
    timestamp: new Date().toISOString(),
    
    // ===== TABLE 1: FACTORS SUPPLYING RESERVE FUNDS =====
    reserveBankCredit: extractWithChanges('Reserve Bank credit'),
    
    // Securities held outright
    securitiesHeld: extractWithChanges('Securities held outright'),
    treasurySecurities: extractWithChanges('U\\.?S\\.? Treasury securities'),
    bills: extractWithChanges('Bills'),
    notesAndBonds: extractWithChanges('Notes and bonds, nominal'),
    tips: extractWithChanges('Notes and bonds, inflation-indexed'),
    inflationComp: extractWithChanges('Inflation compensation'),
    agencyDebt: extractWithChanges('Federal agency debt securities'),
    mbs: extractWithChanges('Mortgage-backed securities'),
    
    // Unamortized premiums/discounts
    unamortizedPremiums: extractWithChanges('Unamortized premiums on securities'),
    unamortizedDiscounts: extractWithChanges('Unamortized discounts on securities'),
    
    // Repurchase agreements
    repos: extractWithChanges('Repurchase agreements'),
    reposForeign: extractWithChanges('Foreign official'),
    reposOthers: extractWithChanges('Others'),
    
    // Loans
    loans: extractWithChanges('Loans'),
    primaryCredit: extractWithChanges('Primary credit'),
    secondaryCredit: extractWithChanges('Secondary credit'),
    seasonalCredit: extractWithChanges('Seasonal credit'),
    ppplf: extractWithChanges('Paycheck Protection Program'),
    btfp: extractWithChanges('Bank Term Funding Program'),
    otherCredit: extractWithChanges('Other credit extensions'),
    
    // Main Street
    mainStreet: extractWithChanges('Net portfolio holdings of MS Facilities|Main Street'),
    
    // Float
    float: extractWithChanges('Float'),
    
    // Central bank liquidity swaps
    swaps: extractWithChanges('Central bank liquidity swaps'),
    
    // Other Federal Reserve assets
    otherFedAssets: extractWithChanges('Other Federal Reserve assets'),
    
    // Foreign currency denominated assets
    foreignCurrency: extractWithChanges('Foreign currency denominated assets'),
    
    // Gold, SDR, Treasury currency
    gold: extractWithChanges('Gold stock'),
    sdr: extractWithChanges('Special drawing rights certificate'),
    treasuryCurrency: extractWithChanges('Treasury currency outstanding'),
    
    // Total supplying
    totalSupplying: extractWithChanges('Total factors supplying'),
    
    // ===== TABLE 1: FACTORS ABSORBING RESERVE FUNDS =====
    currency: extractWithChanges('Currency in circulation'),
    
    // Reverse repurchase agreements
    rrp: extractWithChanges('Reverse repurchase agreements'),
    rrpForeign: extractWithChanges('Foreign official and international'),
    rrpOthers: extractWithChanges('Others'),
    
    // Treasury cash holdings
    treasuryCash: extractWithChanges('Treasury cash holdings'),
    
    // Deposits with F.R. Banks
    deposits: extractWithChanges('Deposits with F\\.?R\\.? Banks'),
    termDeposits: extractWithChanges('Term deposits held by depository'),
    tga: extractWithChanges('U\\.?S\\.? Treasury,? General Account'),
    foreignDeposits: extractWithChanges('Foreign official'),
    otherDeposits: extractWithChanges('Other(?!.*credit)'),
    
    // Treasury contributions
    treasuryContributions: extractWithChanges('Treasury contributions'),
    
    // Other liabilities and capital
    otherLiabilitiesCapital: extractWithChanges('Other liabilities and capital'),
    
    // Total absorbing
    totalAbsorbing: extractWithChanges('Total factors.*other than reserve'),
    
    // Reserve balances
    reserves: extractWithChanges('Reserve balances with Federal Reserve'),
    
    // ===== TABLE 1A: MEMORANDUM ITEMS =====
    // Securities held in custody
    custodyTotal: extractWithChanges('Securities held in custody for foreign'),
    custodyTreasuries: extractWithChanges('Marketable U\\.?S\\.? Treasury securities'),
    custodyAgencyMBS: extractWithChanges('Federal agency debt and mortgage'),
    custodyOther: extractWithChanges('Other securities'),
    
    // Securities lent to dealers
    secLendingTotal: extractWithChanges('Securities lent to dealers'),
    secLendingOvernight: extractWithChanges('Overnight facility'),
    secLendingOvernightTreasury: extractWithChanges('U\\.?S\\.? Treasury securities(?=.*lent|.*dealer)'),
    secLendingOvernightAgency: extractWithChanges('Federal agency debt securities(?=.*lent|.*dealer)'),
    
    // ===== TABLE 5: CONSOLIDATED STATEMENT =====
    // Assets
    goldCertAccount: extractWithChanges('Gold certificate account'),
    sdrCertAccount: extractWithChanges('Special drawing rights certificate account'),
    coin: extractWithChanges('Coin'),
    securitiesLoansTotal: extractWithChanges('Securities.*unamortized.*repurchase.*and loans'),
    itemsInCollection: extractWithChanges('Items in process of collection'),
    bankPremises: extractWithChanges('Bank premises'),
    otherAssets: extractWithChanges('Other assets'),
    totalAssets: extractWithChanges('Total assets'),
    
    // Liabilities
    frNotesNet: extractWithChanges('Federal Reserve notes.*net'),
    depositsTotal: extractWithChanges('Deposits(?!.*with)'),
    otherDepositsDepository: extractWithChanges('Other deposits held by depository'),
    deferredAvailability: extractWithChanges('Deferred availability'),
    otherLiabilities: extractWithChanges('Other liabilities and accrued'),
    totalLiabilities: extractWithChanges('Total liabilities'),
    
    // Capital
    capitalPaidIn: extractWithChanges('Capital paid in'),
    surplus: extractWithChanges('Surplus'),
    otherCapital: extractWithChanges('Other capital'),
    totalCapital: extractWithChanges('Total capital'),
    
    // Earnings remittances
    earningsRemittances: extractWithChanges('Earnings remittances due'),
    
    // ===== TABLE 3: MBS SUPPLEMENTAL =====
    mbsResidential: extractWithChanges('Residential mortgage-backed'),
    mbsCommercial: extractWithChanges('Commercial mortgage-backed'),
    mbsCommitmentsBuy: extractWithChanges('Commitments to buy'),
    mbsCommitmentsSell: extractWithChanges('Commitments to sell'),
    
    // ===== TABLE 7: COLLATERAL =====
    frNotesOutstanding: extractWithChanges('Federal Reserve notes outstanding'),
    frNotesHeldByBanks: extractWithChanges('Notes held by F\\.?R\\.? Banks'),
    frNotesToBeCollateralized: extractWithChanges('Federal Reserve notes to be collateralized'),
    collateralHeld: extractWithChanges('Collateral held against'),
    collateralGold: extractWithChanges('Gold certificate account'),
    collateralSDR: extractWithChanges('Special drawing rights certificate'),
    collateralSecurities: extractWithChanges('Treasury.*agency.*securities pledged'),
    collateralOther: extractWithChanges('Other assets pledged'),
    
    // Legacy support
    secLending: { overnight: extractWithChanges('Overnight'), term: extractWithChanges('Term'), total: extractWithChanges('Total securities lent') },
    frNotes: parseFRNotes(text),
    maturity: parseMaturityTable(text),
    banks: parseBanks(text)
  };

  if (currentData.reserves.v === 0) {
    const m = text.match(/Reserve balances[^\d]*?([\d,]+)/i);
    if (m) currentData.reserves.v = parseInt(m[1].replace(/,/g, ''));
  }

  const idx = savedDataList.findIndex(d => d.releaseDate === currentData.releaseDate);
  if (idx >= 0) savedDataList[idx] = {...currentData};
  else savedDataList.unshift({...currentData});
  savedDataList.sort((a, b) => parseDate(b.releaseDate) - parseDate(a.releaseDate));
  
  if (skipRender) return; // ì—¬ëŸ¬ íŒŒì¼ ì²˜ë¦¬ ì‹œ ë§ˆì§€ë§‰ì—ë§Œ ë Œë”ë§
  
  saveDataToServer();
  currentDataIndex = savedDataList.findIndex(d => d.releaseDate === currentData.releaseDate);
  renderAll();
  document.getElementById('dropzoneInitial').style.display = 'none';
  document.getElementById('tabsContainer').style.display = 'flex';
  updateNavButtons();
  document.querySelector('.tab.active').click();
}

function parseMaturityRow(text, label) {
  const p = new RegExp(label + '[\\s\\S]{0,200}?([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)', 'i');
  const m = text.match(p);
  if (m) return { d15: parseInt(m[1].replace(/,/g, '')) || 0, d90: parseInt(m[2].replace(/,/g, '')) || 0, d1y: parseInt(m[3].replace(/,/g, '')) || 0, y5: parseInt(m[4].replace(/,/g, '')) || 0, y10: parseInt(m[5].replace(/,/g, '')) || 0, y10plus: parseInt(m[6].replace(/,/g, '')) || 0, total: parseInt(m[7].replace(/,/g, '')) || 0 };
  return { d15: 0, d90: 0, d1y: 0, y5: 0, y10: 0, y10plus: 0, total: 0 };
}

function parseMaturityTable(text) {
  // Table 2 ì„¹ì…˜ ì¶”ì¶œ
  const table2Match = text.match(/2\.\s*Maturity Distribution[\s\S]*?(?=3\.\s*Supplemental|H\.4\.1\s*3\.|$)/i);
  const t2 = table2Match ? table2Match[0] : text;
  
  const defaultRow = { d15: 0, d90: 0, d1y: 0, y5: 0, y10: 0, y10plus: 0, total: 0 };
  
  // PDF.js ì¶”ì¶œ í…ìŠ¤íŠ¸ì—ì„œ íŠ¹ì • íŒ¨í„´ì˜ ìˆ«ì ì‹œí€€ìŠ¤ ì°¾ê¸°
  // êµ­ì±„: 68,778 222,464 454,722 1,409,619 491,646 1,596,025 4,243,253
  // (5ìë¦¬ 6ìë¦¬ 6ìë¦¬ 7ìë¦¬ 6ìë¦¬ 7ìë¦¬ 7ìë¦¬ íŒ¨í„´)
  
  let treasury = {...defaultRow};
  // êµ­ì±„ íŠ¹ì§•: 4ë°±ë§ŒëŒ€ ì´ì•¡
  const treasuryPattern = /(\d{2},\d{3})\s+(\d{3},\d{3})\s+(\d{3},\d{3})\s+(\d{1},\d{3},\d{3})\s+(\d{3},\d{3})\s+(\d{1},\d{3},\d{3})\s+(\d{1},\d{3},\d{3})/;
  const tm = t2.match(treasuryPattern);
  if (tm) {
    treasury = {
      d15: parseInt(tm[1].replace(/,/g, '')) || 0,
      d90: parseInt(tm[2].replace(/,/g, '')) || 0,
      d1y: parseInt(tm[3].replace(/,/g, '')) || 0,
      y5: parseInt(tm[4].replace(/,/g, '')) || 0,
      y10: parseInt(tm[5].replace(/,/g, '')) || 0,
      y10plus: parseInt(tm[6].replace(/,/g, '')) || 0,
      total: parseInt(tm[7].replace(/,/g, '')) || 0
    };
  }
  
  // MBS: 0 28 36 4,895 59,200 1,974,865 2,039,024
  // íŠ¹ì§•: 10ë…„+ ì»¬ëŸ¼ì´ ë§¤ìš° í¼ (1,974,865)
  let mbs = {...defaultRow};
  const mbsPattern = /0\s+28\s+36\s+(\d{1},\d{3})\s+(\d{2},\d{3})\s+(\d{1},\d{3},\d{3})\s+(\d{1},\d{3},\d{3})/;
  const mm = t2.match(mbsPattern);
  if (mm) {
    mbs = {
      d15: 0,
      d90: 28,
      d1y: 36,
      y5: parseInt(mm[1].replace(/,/g, '')) || 0,
      y10: parseInt(mm[2].replace(/,/g, '')) || 0,
      y10plus: parseInt(mm[3].replace(/,/g, '')) || 0,
      total: parseInt(mm[4].replace(/,/g, '')) || 0
    };
  }
  
  // Agency Debt: 0 0 0 1,818 529 0 2,347
  // íŠ¹ì§•: ì• 3ê°œ 0, ì´ì•¡ 2ì²œëŒ€
  let agencyDebt = {...defaultRow};
  const agencyPattern = /0\s+0\s+0\s+(\d{1},\d{3})\s+(\d{3})\s+0\s+(\d{1},\d{3})/;
  const am = t2.match(agencyPattern);
  if (am) {
    agencyDebt = {
      d15: 0,
      d90: 0,
      d1y: 0,
      y5: parseInt(am[1].replace(/,/g, '')) || 0,
      y10: parseInt(am[2].replace(/,/g, '')) || 0,
      y10plus: 0,
      total: parseInt(am[3].replace(/,/g, '')) || 0
    };
  }
  
  // Loans: 2,198 3,212 21 (ì§§ì€ í–‰)
  let loans = { d15: 0, d90: 0, d1y: 0 };
  const loansPattern = /(\d{1},\d{3})\s+(\d{1},\d{3})\s+(\d{1,2})\s+0\s+0/;
  const lm = t2.match(loansPattern);
  if (lm) {
    loans = {
      d15: parseInt(lm[1].replace(/,/g, '')) || 0,
      d90: parseInt(lm[2].replace(/,/g, '')) || 0,
      d1y: parseInt(lm[3].replace(/,/g, '')) || 0
    };
  }
  
  // Main Street: 986 123 89
  let mainStreet = { d15: 0, d90: 0, d1y: 0 };
  const msPattern = /(\d{3})\s+(\d{2,3})\s+(\d{2,3})\s+0\s+\.\.\./;
  const msm = t2.match(msPattern);
  if (msm) {
    mainStreet = {
      d15: parseInt(msm[1]) || 0,
      d90: parseInt(msm[2]) || 0,
      d1y: parseInt(msm[3]) || 0
    };
  }
  
  // RRP: 317,751
  let rrp = 0;
  const rrpPattern = /(\d{3},\d{3})\s+0\s+\.\.\.\s+\.\.\.\s+\.\.\.\s+\.\.\.\s+\1/;
  const rrpm = t2.match(rrpPattern);
  if (rrpm) {
    rrp = parseInt(rrpm[1].replace(/,/g, '')) || 0;
  } else {
    // ëŒ€ì•ˆ: Reverse repurchase ê·¼ì²˜ì—ì„œ ì°¾ê¸°
    const rrpAlt = t2.match(/Reverse repurchase.*?(\d{3},\d{3})/i);
    if (rrpAlt) rrp = parseInt(rrpAlt[1].replace(/,/g, '')) || 0;
  }
  
  // Swaps: 122 0 0 0 0 0 122
  let swaps = {...defaultRow};
  const swapsPattern = /(\d{2,3})\s+0\s+0\s+0\s+0\s+0\s+\1/;
  const sm = t2.match(swapsPattern);
  if (sm && parseInt(sm[1]) < 1000) {
    const v = parseInt(sm[1]) || 0;
    swaps = { d15: v, d90: 0, d1y: 0, y5: 0, y10: 0, y10plus: 0, total: v };
  }
  
  // Repos: 1
  let repos = 0;
  const reposPattern = /Repurchase agreements.*?(\d+)/i;
  const rpm = t2.match(reposPattern);
  if (rpm) repos = parseInt(rpm[1]) || 0;
  
  return {
    loans,
    treasury,
    treasuryChanges: defaultRow,
    agencyDebt,
    agencyDebtChanges: defaultRow,
    mbs,
    mbsChanges: defaultRow,
    mainStreet,
    repos,
    swaps,
    rrp,
    termDeposits: 0
  };
}

function parseBanks(text) {
  const bankNames = ['Boston','New York','Philadelphia','Cleveland','Richmond','Atlanta','Chicago','St. Louis','Minneapolis','Kansas City','Dallas','San Francisco'];
  const banksKr = ['ë³´ìŠ¤í„´','ë‰´ìš•','í•„ë¼ë¸í”¼ì•„','í´ë¦¬ë¸”ëœë“œ','ë¦¬ì¹˜ëª¬ë“œ','ì• í‹€ëœíƒ€','ì‹œì¹´ê³ ','ì„¸ì¸íŠ¸ë£¨ì´ìŠ¤','ë¯¸ë‹ˆì• í´ë¦¬ìŠ¤','ìº”ììŠ¤ì‹œí‹°','ëŒˆëŸ¬ìŠ¤','ìƒŒí”„ë€ì‹œìŠ¤ì½”'];
  
  const results = bankNames.map((name, i) => ({
    name,
    kr: banksKr[i],
    assets: 0,
    goldCerts: 0,
    sdrCerts: 0,
    coin: 0,
    securities: 0,
    treasuries: 0,
    mbs: 0,
    repos: 0,
    loans: 0,
    frNotes: 0,
    rrp: 0,
    deposits: 0,
    capital: 0,
    surplus: 0
  }));
  
  // "Statement of Condition of Each Federal Reserve Bank" ì„¹ì…˜ ì°¾ê¸°
  const bankSection = text.match(/Statement of Condition of Each[\s\S]*?(?=Collateral Held|Federal Reserve Notes|$)/i);
  if (!bankSection) {
    // ê¸°ë³¸ê°’ ë°˜í™˜
    const defaults = [169212,3370938,126828,247633,535872,458267,418720,110270,63049,87800,333546,659096];
    results.forEach((r, i) => r.assets = defaults[i]);
    return results;
  }
  
  const section = bankSection[0];
  
  // í•­ëª©ë³„ íŒŒì‹± - í–‰ ë‹¨ìœ„ë¡œ ìˆ«ì 12ê°œ ì¶”ì¶œ
  const parseRow = (pattern) => {
    const regex = new RegExp(pattern + '[^\\d]*([\\d,]+(?:\\s+[\\d,]+){11})', 'i');
    const m = section.match(regex);
    if (m) {
      return m[1].split(/\s+/).map(n => parseInt(n.replace(/,/g, '')) || 0);
    }
    return Array(12).fill(0);
  };
  
  const totalAssets = parseRow('Total assets');
  const goldCerts = parseRow('Gold certificate');
  const sdrCerts = parseRow('Special drawing rights');
  const securities = parseRow('Securities.*held outright');
  const treasuries = parseRow('U\\.?S\\.? Treasury securities');
  const mbsRow = parseRow('Federal agency.*MBS|Mortgage-backed');
  const repos = parseRow('Repurchase agreements');
  const loans = parseRow('Loans(?!.*securities)');
  const frNotes = parseRow('Federal Reserve notes');
  const rrp = parseRow('Reverse repurchase');
  const deposits = parseRow('Deposits(?!.*Treasury)');
  const capital = parseRow('Capital paid');
  const surplus = parseRow('Surplus');
  
  results.forEach((r, i) => {
    r.assets = totalAssets[i] || 0;
    r.goldCerts = goldCerts[i] || 0;
    r.sdrCerts = sdrCerts[i] || 0;
    r.securities = securities[i] || 0;
    r.treasuries = treasuries[i] || 0;
    r.mbs = mbsRow[i] || 0;
    r.repos = repos[i] || 0;
    r.loans = loans[i] || 0;
    r.frNotes = frNotes[i] || 0;
    r.rrp = rrp[i] || 0;
    r.deposits = deposits[i] || 0;
    r.capital = capital[i] || 0;
    r.surplus = surplus[i] || 0;
  });
  
  // ì´ ìì‚°ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
  if (results.every(r => r.assets === 0)) {
    const defaults = [169212,3370938,126828,247633,535872,458267,418720,110270,63049,87800,333546,659096];
    results.forEach((r, i) => r.assets = defaults[i]);
  }
  
  return results;
}

function parseFRNotes(text) {
  const banks = ['Boston','New York','Philadelphia','Cleveland','Richmond','Atlanta','Chicago','St. Louis','Minneapolis','Kansas City','Dallas','San Francisco'];
  const banksKr = ['ë³´ìŠ¤í„´','ë‰´ìš•','í•„ë¼ë¸í”¼ì•„','í´ë¦¬ë¸”ëœë“œ','ë¦¬ì¹˜ëª¬ë“œ','ì• í‹€ëœíƒ€','ì‹œì¹´ê³ ','ì„¸ì¸íŠ¸ë£¨ì´ìŠ¤','ë¯¸ë‹ˆì• í´ë¦¬ìŠ¤','ìº”ììŠ¤ì‹œí‹°','ëŒˆëŸ¬ìŠ¤','ìƒŒí”„ë€ì‹œìŠ¤ì½”'];
  
  const results = banks.map((b, i) => ({ name: b, kr: banksKr[i], outstanding: 0, collateral: 0, gold: 0 }));
  
  // Federal Reserve Notes ì„¹ì…˜ ì°¾ê¸°
  const notesSection = text.match(/Federal Reserve notes.*?outstanding.*?(?=\n\s*\n|\d+\.\s+[A-Z])/is);
  if (!notesSection) return results;
  
  const section = notesSection[0];
  
  // ê° ì—°ì¤€ ì€í–‰ë³„ ë°ì´í„° íŒŒì‹±
  banks.forEach((bank, i) => {
    // ì€í–‰ëª… ë’¤ì˜ ìˆ«ìë“¤ ì°¾ê¸° (outstanding, collateral, gold ìˆœì„œ)
    const bankPattern = new RegExp(bank + '[\\s\\S]*?([\\d,]+)\\s+([\\d,]+)\\s+([\\d,]+)', 'i');
    const match = section.match(bankPattern);
    if (match) {
      results[i].outstanding = parseInt(match[1].replace(/,/g, '')) || 0;
      results[i].collateral = parseInt(match[2].replace(/,/g, '')) || 0;
      results[i].gold = parseInt(match[3].replace(/,/g, '')) || 0;
    }
  });
  
  // ë§Œì•½ ìœ„ ë°©ì‹ìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´, í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„
  if (results.every(r => r.outstanding === 0)) {
    // ìˆ«ì í–‰ë“¤ì„ ì°¾ì•„ì„œ ìˆœì„œëŒ€ë¡œ ë§¤í•‘
    const numberRows = section.match(/[\d,]+\s+[\d,]+\s+[\d,]+/g);
    if (numberRows) {
      numberRows.slice(0, 12).forEach((row, i) => {
        const nums = row.match(/[\d,]+/g);
        if (nums && nums.length >= 3 && i < 12) {
          results[i].outstanding = parseInt(nums[0].replace(/,/g, '')) || 0;
          results[i].collateral = parseInt(nums[1].replace(/,/g, '')) || 0;
          results[i].gold = parseInt(nums[2].replace(/,/g, '')) || 0;
        }
      });
    }
  }
  
  return results;
}

function fmt(n) { return n == null ? '-' : new Intl.NumberFormat('en-US').format(n); }
function fmtChg(n) { return (n == null || n === 0) ? '-' : (n > 0 ? '+' : '') + fmt(n); }
function fmtPct(n) { return (n == null || n === 0) ? '-' : (n > 0 ? '+' : '') + n.toFixed(2) + '%'; }
function calcPct(change, base) { return (base && change) ? (change / base * 100) : 0; }
function chgClass(n) { return (n == null || n === 0) ? '' : (n > 0 ? 'pos' : 'neg'); }
function showTab(id, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(id).classList.add('active');
  if (id === 'charts') renderCharts();
}
function openModal(id) { document.getElementById(id).classList.add('open'); if (id === 'historyModal') renderSavedList(); if (id === 'settingsModal') applySettings(); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function parseDate(str) {
  const months = {January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11};
  const m = str.match(/(\w+)\s+(\d+),?\s*(\d{4})/);
  if (m) return new Date(parseInt(m[3]), months[m[1]] || 0, parseInt(m[2]));
  return new Date(str);
}

function renderSavedList() {
  document.getElementById('dataCount').textContent = savedDataList.length ? `(${savedDataList.length}ê°œ)` : '';
  document.getElementById('deleteAllBtn').style.display = savedDataList.length > 0 ? 'inline-block' : 'none';
  const el = document.getElementById('savedDataList');
  if (!savedDataList.length) { el.innerHTML = '<p style="color:var(--text2);text-align:center;padding:40px 0">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
  el.innerHTML = savedDataList.map((d,i) => `<div class="saved-item" onclick="loadSaved(${i})"><div><div class="saved-date">${d.releaseDate}</div><div class="saved-val">ì´ìì‚°: $${fmt(d.totalAssets?.v || d.totalSupplying?.v)}M</div></div><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteSaved(${i})">ì‚­ì œ</button></div>`).join('');
}

function deleteAllData() {
  if (!confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  savedDataList = [];
  currentData = {};
  currentDataIndex = 0;
  saveDataToServer();
  renderSavedList();
  document.getElementById('dropzoneInitial').style.display = 'block';
  document.getElementById('tabsContainer').style.display = 'none';
  updateNavButtons();
  closeModal('historyModal');
  showToast('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

let currentDataIndex = 0;

function navData(dir) {
  const newIndex = currentDataIndex + dir;
  if (newIndex < 0 || newIndex >= savedDataList.length) return;
  currentDataIndex = newIndex;
  currentData = savedDataList[currentDataIndex];
  renderAll();
  updateNavButtons();
}

function updateNavButtons() {
  const navArrows = document.getElementById('navArrows');
  if (savedDataList.length > 1) {
    navArrows.style.display = 'flex';
    document.getElementById('navPrev').disabled = currentDataIndex === 0;
    document.getElementById('navNext').disabled = currentDataIndex === savedDataList.length - 1;
  } else {
    navArrows.style.display = 'none';
  }
}

function loadSaved(i) {
  currentDataIndex = i;
  currentData = savedDataList[i];
  renderAll();
  document.getElementById('dropzoneInitial').style.display = 'none';
  document.getElementById('tabsContainer').style.display = 'flex';
  updateNavButtons();
  closeModal('historyModal');
}

function deleteSaved(i) {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  savedDataList.splice(i, 1);
  saveDataToServer();
  renderSavedList();
  showToast('ğŸ—‘ï¸ ì‚­ì œë¨');
}

function renderAll() {
  if (!currentData) return;
  document.getElementById('releaseDate').textContent = currentData.releaseDate;
  document.getElementById('asOfDate').textContent = currentData.asOfDate;
  renderOverview();
  renderFactors();
  renderFactorsSummary();
  renderMaturity();
  renderLoans();
  renderConsolidated();
  renderBanks();
  renderFRNotes();
}

function renderOverview() {
  const d = currentData;
  const totalAssets = d.totalAssets?.v || d.totalSupplying?.v || 0;
  const treasury = d.treasurySecurities?.v || 0;
  const mbs = d.mbs?.v || 0;
  const metrics = [{kr:'ì´ ìì‚°',en:'Total Assets',...d.totalSupplying,desc:'ì—°ì¤€ ë³´ìœ  ëª¨ë“  ìì‚°'},{kr:'ë³´ìœ  ì¦ê¶Œ',en:'Securities Held',...d.securitiesHeld,desc:'êµ­ì±„ + MBS + ê¸°ê´€ì±„'},{kr:'ì§€ê¸‰ì¤€ë¹„ê¸ˆ',en:'Reserve Balances',...d.reserves,desc:'ì€í–‰ë“¤ì˜ ì—°ì¤€ ì˜ˆì¹˜ ì¤€ë¹„ê¸ˆ'},{kr:'ì¬ë¬´ë¶€ ì¼ë°˜ê³„ì •',en:'TGA',...d.tga,desc:'ì •ë¶€ì˜ ë‹¹ì¢Œì˜ˆê¸ˆ'},{kr:'ì—­í™˜ë§¤ì¡°ê±´ë¶€',en:'Reverse Repo',...d.rrp,desc:'ë‹¨ê¸° ìœ ë™ì„± í¡ìˆ˜'},{kr:'ìœ í†µ í†µí™”',en:'Currency',...d.currency,desc:'ì‹œì¤‘ í˜„ê¸ˆ'}];
  
  let html = '<div class="grid">' + metrics.map(m => {
    const wPct = calcPct(m.w, m.v - m.w);
    const yPct = calcPct(m.y, m.v - m.y);
    return `<div class="card"><div class="card-hd"><span class="card-kr">${m.kr}</span><span class="card-en">${m.en}</span></div><div class="card-val">$${fmt(m.v)}M</div><div class="card-desc">${m.desc}</div><div class="badges"><span class="badge ${chgClass(m.w)}">ì£¼ê°„: ${fmtChg(m.w)} (${fmtPct(wPct)})</span><span class="badge ${chgClass(m.y)}">ì—°ê°„: ${fmtChg(m.y)} (${fmtPct(yPct)})</span></div></div>`;
  }).join('') + '</div>';
  
  const tsyPct = totalAssets ? (treasury / totalAssets * 100).toFixed(1) : 0;
  const mbsPct = totalAssets ? (mbs / totalAssets * 100).toFixed(1) : 0;
  const othPct = Math.max(0, 100 - tsyPct - mbsPct).toFixed(1);
  html += `<div class="box"><h3>ìì‚° êµ¬ì„±</h3><div class="bar-grp"><div class="bar-lbl">ì´ ìì‚° <span>$${(totalAssets/1e6).toFixed(2)}T</span></div><div class="sbar"><div class="seg tsy" style="width:${tsyPct}%"></div><div class="seg mbs" style="width:${mbsPct}%"></div><div class="seg oth" style="width:${othPct}%"></div></div><div class="leg"><span><i class="dot tsy"></i>êµ­ì±„ ${tsyPct}%</span><span><i class="dot mbs"></i>MBS ${mbsPct}%</span><span><i class="dot oth"></i>ê¸°íƒ€ ${othPct}%</span></div></div></div>`;
  document.getElementById('overview').innerHTML = html;
}

function renderFactors() {
  const d = currentData;
  const isDetailed = localStorage.getItem('fed-detailed') !== 'false';
  
  const row = (label, kr, data, lvl=0, show=true) => {
    if (!show && !isDetailed) return '';
    const wPct = calcPct(data?.w, data?.v - (data?.w || 0));
    const yPct = calcPct(data?.y, data?.v - (data?.y || 0));
    const cls = lvl ? 'l'+lvl : '';
    return `<tr class="${cls}"><td><div class="bil"><span class="kr">${kr}</span><span class="en">${label}</span></div></td><td class="val">${fmt(data?.v)}</td><td class="chg ${chgClass(data?.w)}">${fmtChg(data?.w)}<br><small>${fmtPct(wPct)}</small></td><td class="chg ${chgClass(data?.y)}">${fmtChg(data?.y)}<br><small>${fmtPct(yPct)}</small></td></tr>`;
  };
  
  const summaryCard = (kr, en, data, desc) => {
    const wPct = calcPct(data?.w, data?.v - (data?.w || 0));
    const yPct = calcPct(data?.y, data?.v - (data?.y || 0));
    return `<div class="card"><div class="card-hd"><span class="card-kr">${kr}</span><span class="card-en">${en}</span></div><div class="card-val">$${fmt(data?.v)}M</div><div class="card-desc">${desc}</div><div class="badges"><span class="badge ${chgClass(data?.w)}">ì£¼ê°„: ${fmtChg(data?.w)} (${fmtPct(wPct)})</span><span class="badge ${chgClass(data?.y)}">ì—°ê°„: ${fmtChg(data?.y)} (${fmtPct(yPct)})</span></div></div>`;
  };
  
  document.getElementById('factors').innerHTML = `
    <div class="view-toggle">
      <button class="toggle-btn ${isDetailed ? 'active' : ''}" onclick="setDetailedView(true)">ìƒì„¸</button>
      <button class="toggle-btn ${!isDetailed ? 'active' : ''}" onclick="setDetailedView(false)">ì¶•ì•½</button>
    </div>
    <div class="tbl-box">
      <h3>ì§€ê¸‰ì¤€ë¹„ê¸ˆ ì˜í–¥ ìš”ì¸</h3>
      <p class="tbl-sub">Table 1: Factors Affecting Reserve Balances of Depository Institutions Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p>
      <div class="stmt-grid">
        <div class="stmt-sec">
          <h4>ê³µê¸‰ ìš”ì¸ SUPPLYING RESERVE FUNDS</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('Reserve Bank Credit','ì—°ì¤€ ì‹ ìš©',d.reserveBankCredit)}
              ${row('Securities Held Outright','ë³´ìœ  ì¦ê¶Œ',d.securitiesHeld,1)}
              ${row('U.S. Treasury Securities','ë¯¸ êµ­ì±„',d.treasurySecurities,2)}
              ${row('Bills','ë‹¨ê¸°ì±„ (T-Bills)',d.bills,2,false)}
              ${row('Notes and Bonds, Nominal','ì¤‘ì¥ê¸°ì±„ (ëª…ëª©)',d.notesAndBonds,2,false)}
              ${row('Notes and Bonds, Inflation-indexed','ë¬¼ê°€ì—°ë™ì±„ (TIPS)',d.tips,2,false)}
              ${row('Inflation Compensation','ì¸í”Œë ˆì´ì…˜ ë³´ì •',d.inflationComp,2,false)}
              ${row('Federal Agency Debt Securities','ì—°ë°©ê¸°ê´€ì±„',d.agencyDebt,2,false)}
              ${row('Mortgage-Backed Securities','MBS',d.mbs,2)}
              ${row('Unamortized Premiums','ë¯¸ìƒê° í”„ë¦¬ë¯¸ì—„',d.unamortizedPremiums,1,false)}
              ${row('Unamortized Discounts','ë¯¸ìƒê° í• ì¸',d.unamortizedDiscounts,1,false)}
              ${row('Repurchase Agreements','ë ˆí¬',d.repos,1)}
              ${row('Foreign Official','ì™¸êµ­ ê³µì‹ê¸°ê´€',d.reposForeign,2,false)}
              ${row('Others','ê¸°íƒ€',d.reposOthers,2,false)}
              ${row('Loans','ëŒ€ì¶œ',d.loans,1)}
              ${row('Primary Credit','1ì°¨ ì‹ ìš©',d.primaryCredit,2,false)}
              ${row('Secondary Credit','2ì°¨ ì‹ ìš©',d.secondaryCredit,2,false)}
              ${row('Seasonal Credit','ê³„ì ˆ ì‹ ìš©',d.seasonalCredit,2,false)}
              ${row('PPPLF','ê¸‰ì—¬ë³´í˜¸í”„ë¡œê·¸ë¨',d.ppplf,2,false)}
              ${row('Bank Term Funding Program','BTFP',d.btfp,2,false)}
              ${row('Other Credit Extensions','ê¸°íƒ€ ì‹ ìš©',d.otherCredit,2,false)}
              ${row('Main Street Lending Program','ë©”ì¸ìŠ¤íŠ¸ë¦¬íŠ¸',d.mainStreet,1,false)}
              ${row('Float','í”Œë¡œíŠ¸',d.float,1,false)}
              ${row('Central Bank Liquidity Swaps','í†µí™”ìŠ¤ì™‘',d.swaps,1)}
              ${row('Other Federal Reserve Assets','ê¸°íƒ€ ì—°ì¤€ ìì‚°',d.otherFedAssets,1,false)}
              ${row('Foreign Currency Denominated Assets','ì™¸í™”í‘œì‹œ ìì‚°',d.foreignCurrency,1,false)}
              ${row('Gold Stock','ê¸ˆ',d.gold)}
              ${row('SDR Certificate Account','SDR ì¦ì„œ',d.sdr)}
              ${row('Treasury Currency Outstanding','ì¬ë¬´ë¶€ í†µí™”',d.treasuryCurrency,0,false)}
              <tr class="tot"><td><strong>Total Factors Supplying</strong></td><td class="val"><strong>${fmt(d.totalSupplying?.v)}</strong></td><td class="chg ${chgClass(d.totalSupplying?.w)}"><strong>${fmtChg(d.totalSupplying?.w)}</strong></td><td class="chg ${chgClass(d.totalSupplying?.y)}"><strong>${fmtChg(d.totalSupplying?.y)}</strong></td></tr>
            </tbody>
          </table>
        </div>
        <div class="stmt-sec">
          <h4>í¡ìˆ˜ ìš”ì¸ ABSORBING RESERVE FUNDS</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('Currency in Circulation','ìœ í†µ í†µí™”',d.currency)}
              ${row('Reverse Repurchase Agreements','ì—­ë ˆí¬',d.rrp)}
              ${row('Foreign Official and International','ì™¸êµ­ ê³µì‹/êµ­ì œê¸°ê´€',d.rrpForeign,1,false)}
              ${row('Others','ê¸°íƒ€ (ON RRP)',d.rrpOthers,1,false)}
              ${row('Treasury Cash Holdings','ì¬ë¬´ë¶€ í˜„ê¸ˆ',d.treasuryCash,0,false)}
              ${row('Deposits with F.R. Banks','ì—°ì¤€ ì˜ˆì¹˜ê¸ˆ',d.deposits)}
              ${row('Term Deposits','ì •ê¸°ì˜ˆê¸ˆ',d.termDeposits,1,false)}
              ${row('U.S. Treasury, General Account','TGA',d.tga,1)}
              ${row('Foreign Official','ì™¸êµ­ ê³µì‹ê¸°ê´€',d.foreignDeposits,1,false)}
              ${row('Other','ê¸°íƒ€',d.otherDeposits,1,false)}
              ${row('Treasury Contributions to Credit Facilities','ì¬ë¬´ë¶€ ì¶œì',d.treasuryContributions,0,false)}
              ${row('Other Liabilities and Capital','ê¸°íƒ€ ë¶€ì±„/ìë³¸',d.otherLiabilitiesCapital,0,false)}
              <tr class="tot"><td><strong>Total Factors Absorbing</strong></td><td class="val"><strong>${fmt(d.totalAbsorbing?.v)}</strong></td><td class="chg ${chgClass(d.totalAbsorbing?.w)}"><strong>${fmtChg(d.totalAbsorbing?.w)}</strong></td><td class="chg ${chgClass(d.totalAbsorbing?.y)}"><strong>${fmtChg(d.totalAbsorbing?.y)}</strong></td></tr>
              <tr class="hi"><td><strong>Reserve Balances</strong></td><td class="val"><strong>${fmt(d.reserves?.v)}</strong></td><td class="chg ${chgClass(d.reserves?.w)}"><strong>${fmtChg(d.reserves?.w)}</strong></td><td class="chg ${chgClass(d.reserves?.y)}"><strong>${fmtChg(d.reserves?.y)}</strong></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="summary-row">
        ${summaryCard('ê³µê¸‰ í•©ê³„','Total Supplying',d.totalSupplying,'ì¤€ë¹„ê¸ˆ ê³µê¸‰ ìš”ì¸ ì´í•©')}
        ${summaryCard('í¡ìˆ˜ í•©ê³„','Total Absorbing',d.totalAbsorbing,'ì¤€ë¹„ê¸ˆ í¡ìˆ˜ ìš”ì¸ ì´í•©')}
        ${summaryCard('ì§€ê¸‰ì¤€ë¹„ê¸ˆ','Reserve Balances',d.reserves,'ê³µê¸‰ - í¡ìˆ˜ = ì¤€ë¹„ê¸ˆ')}
      </div>
    </div>
  `;
}

function setDetailedView(detailed) {
  localStorage.setItem('fed-detailed', detailed);
  renderFactors();
  renderFactorsSummary();
  renderConsolidated();
}

function renderFactorsSummary() {
  const d = currentData;
  const isDetailed = localStorage.getItem('fed-detailed') !== 'false';
  
  const row = (kr, en, data, lvl=0, show=true) => {
    if (!show && !isDetailed) return '';
    const wPct = calcPct(data?.w, data?.v - (data?.w || 0));
    const cls = lvl ? 'l'+lvl : '';
    return `<tr class="${cls}"><td><div class="bil"><span class="kr">${kr}</span><span class="en">${en}</span></div></td><td class="val">${fmt(data?.v)}</td><td class="chg ${chgClass(data?.w)}">${fmtChg(data?.w)}</td><td class="chg ${chgClass(data?.y)}">${fmtChg(data?.y)}</td></tr>`;
  };
  
  document.getElementById('factorsSummary').innerHTML = `
    <div class="view-toggle">
      <button class="toggle-btn ${isDetailed ? 'active' : ''}" onclick="setDetailedView(true)">ìƒì„¸</button>
      <button class="toggle-btn ${!isDetailed ? 'active' : ''}" onclick="setDetailedView(false)">ì¶•ì•½</button>
    </div>
    <div class="tbl-box">
      <h3>ê¸°ë¡ í•­ëª©</h3>
      <p class="tbl-sub">Table 1A: Memorandum Items Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p>
      <div class="stmt-grid">
        <div class="stmt-sec">
          <h4>ì™¸êµ­ ê³µì‹ê¸°ê´€ ë³´ê´€ ì¦ê¶Œ</h4>
          <p style="color:var(--text3);font-size:0.85em;margin-bottom:12px">Securities held in custody for foreign official and international accounts</p>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ë³´ê´€ ì¦ê¶Œ í•©ê³„','Total',d.custodyTotal)}
              ${row('ì‹œì¥ì„± ë¯¸ êµ­ì±„','Marketable U.S. Treasury Securities',d.custodyTreasuries,1)}
              ${row('ê¸°ê´€ì±„ ë° MBS','Federal Agency Debt and MBS',d.custodyAgencyMBS,1)}
              ${row('ê¸°íƒ€ ì¦ê¶Œ','Other Securities',d.custodyOther,1,false)}
            </tbody>
          </table>
        </div>
        <div class="stmt-sec">
          <h4>ë”œëŸ¬ ëŒ€ì¶œ ì¦ê¶Œ</h4>
          <p style="color:var(--text3);font-size:0.85em;margin-bottom:12px">Securities lent to dealers</p>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ëŒ€ì¶œ ì¦ê¶Œ í•©ê³„','Total',d.secLendingTotal)}
              ${row('ìµì¼ë¬¼ ì‹œì„¤','Overnight Facility',d.secLendingOvernight,1)}
              ${row('ë¯¸ êµ­ì±„','U.S. Treasury Securities',d.secLendingOvernightTreasury,2,false)}
              ${row('ì—°ë°©ê¸°ê´€ì±„','Federal Agency Debt Securities',d.secLendingOvernightAgency,2,false)}
            </tbody>
          </table>
        </div>
      </div>
      <div class="info" style="margin-top:20px">
        <h4>ê¸°ë¡ í•­ëª© ì„¤ëª…</h4>
        <p style="color:var(--text2);line-height:1.6">
          <strong>ì™¸êµ­ ê³µì‹ê¸°ê´€ ë³´ê´€ ì¦ê¶Œ</strong>: ì™¸êµ­ ì¤‘ì•™ì€í–‰ ë° êµ­ì œê¸°êµ¬ê°€ ì—°ì¤€ì— ë³´ê´€ì„ ë§¡ê¸´ ì¦ê¶Œì…ë‹ˆë‹¤. ì—°ì¤€ ëŒ€ì°¨ëŒ€ì¡°í‘œì—ëŠ” í¬í•¨ë˜ì§€ ì•Šì§€ë§Œ, ê¸€ë¡œë²Œ ë‹¬ëŸ¬ ìˆ˜ìš”ì™€ ì™¸êµ­ì˜ ë¯¸êµ­ êµ­ì±„ ë³´ìœ  ë™í–¥ì„ ë‚˜íƒ€ë‚´ëŠ” ì¤‘ìš” ì§€í‘œì…ë‹ˆë‹¤.<br><br>
          <strong>ë”œëŸ¬ ëŒ€ì¶œ ì¦ê¶Œ</strong>: SOMA(System Open Market Account) í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ­ì±„ë¥¼ 1ì°¨ ë”œëŸ¬ì—ê²Œ ì¼ì‹œì ìœ¼ë¡œ ëŒ€ì¶œí•˜ì—¬ êµ­ì±„ ì‹œì¥ì˜ ìœ ë™ì„±ê³¼ ê¸°ëŠ¥ì„ ì§€ì›í•©ë‹ˆë‹¤. ë‹´ë³´ëŠ” ë¯¸ êµ­ì±„ë¡œ ì™„ì „íˆ ì¶©ë‹¹ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  `;
}

function renderMaturity() {
  const m = currentData.maturity || {};
  const t = m.treasury || {};
  const tChg = m.treasuryChanges || {};
  const agency = m.agencyDebt || {};
  const agencyChg = m.agencyDebtChanges || {};
  const mbs = m.mbs || {};
  const mbsChg = m.mbsChanges || {};
  const loans = m.loans || {};
  const mainStreet = m.mainStreet || {};
  const swaps = m.swaps || {};
  
  const isDetailed = localStorage.getItem('fed-detailed') !== 'false';
  
  const maxVal = Math.max(t.y5 || 0, t.y10plus || 0, 1);
  const cols = [{lbl:'15ì¼â†“',v:t.d15},{lbl:'16-90ì¼',v:t.d90},{lbl:'91ì¼-1ë…„',v:t.d1y},{lbl:'1-5ë…„',v:t.y5},{lbl:'5-10ë…„',v:t.y10},{lbl:'10ë…„â†‘',v:t.y10plus}];
  
  const fmtCell = (v) => v ? fmt(v) : '-';
  const fmtChgCell = (v) => {
    if (!v) return '-';
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : '';
    return `<span class="${cls}">${v > 0 ? '+' : ''}${fmt(v)}</span>`;
  };
  
  document.getElementById('maturity').innerHTML = `
    <div class="view-toggle">
      <button class="toggle-btn ${isDetailed ? 'active' : ''}" onclick="setDetailedView(true);renderMaturity()">ìƒì„¸</button>
      <button class="toggle-btn ${!isDetailed ? 'active' : ''}" onclick="setDetailedView(false);renderMaturity()">ì¶•ì•½</button>
    </div>
    <div class="tbl-box">
      <h3>ë§Œê¸°ë³„ ìì‚°/ë¶€ì±„ ë¶„í¬</h3>
      <p class="tbl-sub">Table 2: Maturity Distribution of Securities, Loans, and Selected Other Assets and Liabilities Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p>
      
      <table>
        <thead>
          <tr>
            <th>ì”ì¡´ë§Œê¸°</th>
            <th>15ì¼â†“</th>
            <th>16-90ì¼</th>
            <th>91ì¼-1ë…„</th>
            <th>1-5ë…„</th>
            <th>5-10ë…„</th>
            <th>10ë…„â†‘</th>
            <th>í•©ê³„</th>
          </tr>
        </thead>
        <tbody>
          <!-- Loans -->
          <tr>
            <td><div class="bil"><span class="kr">ëŒ€ì¶œ</span><span class="en">Loans</span></div></td>
            <td class="val">${fmtCell(loans.d15)}</td>
            <td class="val">${fmtCell(loans.d90)}</td>
            <td class="val">${fmtCell(loans.d1y)}</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">${fmtCell((loans.d15||0)+(loans.d90||0)+(loans.d1y||0))}</td>
          </tr>
          
          <!-- U.S. Treasury securities -->
          <tr>
            <td><div class="bil"><span class="kr">ë¯¸ êµ­ì±„</span><span class="en">U.S. Treasury Securities</span></div></td>
            <td class="val">${fmtCell(t.d15)}</td>
            <td class="val">${fmtCell(t.d90)}</td>
            <td class="val">${fmtCell(t.d1y)}</td>
            <td class="val">${fmtCell(t.y5)}</td>
            <td class="val">${fmtCell(t.y10)}</td>
            <td class="val">${fmtCell(t.y10plus)}</td>
            <td class="val">${fmtCell(t.total)}</td>
          </tr>
          ${isDetailed ? `
          <tr class="l1" style="background:var(--bg2)">
            <td style="padding-left:24px;font-size:0.9em;color:var(--text2)">ì£¼ê°„ ë³€ë™</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.d15)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.d90)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.d1y)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.y5)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.y10)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.y10plus)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(tChg.total)}</td>
          </tr>
          ` : ''}
          
          <!-- Federal agency debt securities -->
          <tr>
            <td><div class="bil"><span class="kr">ì—°ë°©ê¸°ê´€ì±„</span><span class="en">Federal Agency Debt Securities</span></div></td>
            <td class="val">${fmtCell(agency.d15)}</td>
            <td class="val">${fmtCell(agency.d90)}</td>
            <td class="val">${fmtCell(agency.d1y)}</td>
            <td class="val">${fmtCell(agency.y5)}</td>
            <td class="val">${fmtCell(agency.y10)}</td>
            <td class="val">${fmtCell(agency.y10plus)}</td>
            <td class="val">${fmtCell(agency.total)}</td>
          </tr>
          ${isDetailed ? `
          <tr class="l1" style="background:var(--bg2)">
            <td style="padding-left:24px;font-size:0.9em;color:var(--text2)">ì£¼ê°„ ë³€ë™</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.d15)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.d90)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.d1y)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.y5)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.y10)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.y10plus)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(agencyChg.total)}</td>
          </tr>
          ` : ''}
          
          <!-- Mortgage-backed securities -->
          <tr>
            <td><div class="bil"><span class="kr">MBS</span><span class="en">Mortgage-Backed Securities</span></div></td>
            <td class="val">${fmtCell(mbs.d15)}</td>
            <td class="val">${fmtCell(mbs.d90)}</td>
            <td class="val">${fmtCell(mbs.d1y)}</td>
            <td class="val">${fmtCell(mbs.y5)}</td>
            <td class="val">${fmtCell(mbs.y10)}</td>
            <td class="val">${fmtCell(mbs.y10plus)}</td>
            <td class="val">${fmtCell(mbs.total)}</td>
          </tr>
          ${isDetailed ? `
          <tr class="l1" style="background:var(--bg2)">
            <td style="padding-left:24px;font-size:0.9em;color:var(--text2)">ì£¼ê°„ ë³€ë™</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.d15)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.d90)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.d1y)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.y5)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.y10)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.y10plus)}</td>
            <td class="val" style="font-size:0.85em">${fmtChgCell(mbsChg.total)}</td>
          </tr>
          ` : ''}
          
          ${isDetailed ? `
          <!-- Main Street Lending -->
          <tr>
            <td><div class="bil"><span class="kr">ë©”ì¸ìŠ¤íŠ¸ë¦¬íŠ¸</span><span class="en">Loan Participations (Main Street)</span></div></td>
            <td class="val">${fmtCell(mainStreet.d15)}</td>
            <td class="val">${fmtCell(mainStreet.d90)}</td>
            <td class="val">${fmtCell(mainStreet.d1y)}</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">${fmtCell((mainStreet.d15||0)+(mainStreet.d90||0)+(mainStreet.d1y||0))}</td>
          </tr>
          
          <!-- Repurchase agreements -->
          <tr>
            <td><div class="bil"><span class="kr">ë ˆí¬</span><span class="en">Repurchase Agreements</span></div></td>
            <td class="val">${fmtCell(m.repos)}</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">${fmtCell(m.repos)}</td>
          </tr>
          
          <!-- Central bank liquidity swaps -->
          <tr>
            <td><div class="bil"><span class="kr">í†µí™”ìŠ¤ì™‘</span><span class="en">Central Bank Liquidity Swaps</span></div></td>
            <td class="val">${fmtCell(swaps.d15)}</td>
            <td class="val">${fmtCell(swaps.d90)}</td>
            <td class="val">${fmtCell(swaps.d1y)}</td>
            <td class="val">${fmtCell(swaps.y5)}</td>
            <td class="val">${fmtCell(swaps.y10)}</td>
            <td class="val">${fmtCell(swaps.y10plus)}</td>
            <td class="val">${fmtCell(swaps.total)}</td>
          </tr>
          
          <!-- Reverse repurchase agreements -->
          <tr>
            <td><div class="bil"><span class="kr">ì—­ë ˆí¬</span><span class="en">Reverse Repurchase Agreements</span></div></td>
            <td class="val">${fmtCell(m.rrp)}</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">${fmtCell(m.rrp)}</td>
          </tr>
          
          <!-- Term deposits -->
          <tr>
            <td><div class="bil"><span class="kr">ì •ê¸°ì˜ˆê¸ˆ</span><span class="en">Term Deposits</span></div></td>
            <td class="val">${fmtCell(m.termDeposits)}</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">-</td>
            <td class="val">${fmtCell(m.termDeposits)}</td>
          </tr>
          ` : ''}
        </tbody>
      </table>
      
      <h4 style="margin-top:24px">êµ­ì±„ ë§Œê¸° ë¶„í¬ ì°¨íŠ¸</h4>
      <div class="mat-chart">
        ${cols.map(c => `
          <div class="mat-col">
            <div class="mat-bar-wrap">
              <div class="mat-bar" style="height:${Math.max(5,(c.v||0)/maxVal*140)}px"></div>
            </div>
            <div class="mat-lbl">${c.lbl}</div>
            <div class="mat-val">$${fmt(Math.round((c.v||0)/1000))}B</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderLoans() {
  const d = currentData;
  const sl = d.secLending || {};
  const isDetailed = localStorage.getItem('fed-detailed') !== 'false';
  
  const row = (kr, en, data, lvl=0, show=true) => {
    if (!show && !isDetailed) return '';
    const cls = lvl ? 'l'+lvl : '';
    return `<tr class="${cls}"><td><div class="bil"><span class="kr">${kr}</span><span class="en">${en}</span></div></td><td class="val">${fmt(data?.v)}</td><td class="chg ${chgClass(data?.w)}">${fmtChg(data?.w)}</td><td class="chg ${chgClass(data?.y)}">${fmtChg(data?.y)}</td></tr>`;
  };
  
  document.getElementById('loans').innerHTML = `
    <div class="view-toggle">
      <button class="toggle-btn ${isDetailed ? 'active' : ''}" onclick="setDetailedView(true);renderLoans()">ìƒì„¸</button>
      <button class="toggle-btn ${!isDetailed ? 'active' : ''}" onclick="setDetailedView(false);renderLoans()">ì¶•ì•½</button>
    </div>
    <div class="tbl-box">
      <h3>ëŒ€ì¶œ ë° ì¦ê¶Œ ëŒ€ì¶œ</h3>
      <p class="tbl-sub">Loans & Securities Lending Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p>
      <div class="stmt-grid">
        <div class="stmt-sec">
          <h4>ëŒ€ì¶œ Loans</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ëŒ€ì¶œ í•©ê³„','Total Loans',d.loans)}
              ${row('1ì°¨ ì‹ ìš©','Primary Credit',d.primaryCredit,1)}
              ${row('2ì°¨ ì‹ ìš©','Secondary Credit',d.secondaryCredit,1,false)}
              ${row('ê³„ì ˆ ì‹ ìš©','Seasonal Credit',d.seasonalCredit,1,false)}
              ${row('ê¸‰ì—¬ë³´í˜¸í”„ë¡œê·¸ë¨','PPPLF',d.ppplf,1,false)}
              ${row('ì€í–‰ê¸°ê°„ëŒ€ì¶œ','BTFP',d.btfp,1)}
              ${row('ê¸°íƒ€ ì‹ ìš©','Other Credit Extensions',d.otherCredit,1,false)}
            </tbody>
          </table>
          <div class="info" style="margin-top:16px;border:none;padding:12px 0 0 0">
            <p style="color:var(--text2);font-size:0.9em;line-height:1.6">
              <strong>1ì°¨ ì‹ ìš© (Primary Credit)</strong>: ì¬ì • ê±´ì „í•œ ì˜ˆê¸ˆê¸°ê´€ì— í• ì¸ìœ¨(discount rate)ë¡œ ì œê³µí•˜ëŠ” ë‹¨ê¸° ëŒ€ì¶œ<br>
              <strong>2ì°¨ ì‹ ìš© (Secondary Credit)</strong>: 1ì°¨ ì‹ ìš© ìê²©ì´ ì•ˆ ë˜ëŠ” ê¸°ê´€ì— ë†’ì€ ê¸ˆë¦¬ë¡œ ì œê³µ<br>
              <strong>ê³„ì ˆ ì‹ ìš© (Seasonal Credit)</strong>: ë†ì—…/ê´€ê´‘ ë“± ê³„ì ˆì  ìê¸ˆ ìˆ˜ìš”ê°€ ìˆëŠ” ì†Œê·œëª¨ ê¸°ê´€ì— ì œê³µ<br>
              <strong>PPPLF</strong>: ì½”ë¡œë‚˜19 ê¸‰ì—¬ë³´í˜¸í”„ë¡œê·¸ë¨ ëŒ€ì¶œ (2021ë…„ ì¢…ë£Œ)<br>
              <strong>BTFP</strong>: 2023ë…„ ì€í–‰ìœ„ê¸° ëŒ€ì‘ ê¸´ê¸‰ ëŒ€ì¶œ í”„ë¡œê·¸ë¨ (2024ë…„ ì¢…ë£Œ)
            </p>
          </div>
        </div>
        <div class="stmt-sec">
          <h4>ì¦ê¶Œ ëŒ€ì¶œ Securities Lending</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ëŒ€ì¶œ ì¦ê¶Œ í•©ê³„','Total Securities Lent',d.secLendingTotal || sl.total)}
              ${row('ìµì¼ë¬¼ ì‹œì„¤','Overnight Facility',d.secLendingOvernight || sl.overnight,1)}
              ${row('ë¯¸ êµ­ì±„','U.S. Treasury Securities',d.secLendingOvernightTreasury,2,false)}
              ${row('ì—°ë°©ê¸°ê´€ì±„','Federal Agency Debt Securities',d.secLendingOvernightAgency,2,false)}
            </tbody>
          </table>
          <div class="info" style="margin-top:16px;border:none;padding:12px 0 0 0">
            <p style="color:var(--text2);font-size:0.9em;line-height:1.6">
              <strong>ì¦ê¶Œ ëŒ€ì¶œ ì‹œì„¤ (Securities Lending Facility)</strong>: SOMA í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ­ì±„ ë° ê¸°ê´€ì±„ë¥¼ 1ì°¨ ë”œëŸ¬ì—ê²Œ ì¼ì‹œì ìœ¼ë¡œ ëŒ€ì¶œí•˜ì—¬ êµ­ì±„ ì‹œì¥ì˜ ìœ ë™ì„±ê³¼ ê¸°ëŠ¥ì„ ì§€ì›í•©ë‹ˆë‹¤. ë‹´ë³´ëŠ” ë¯¸ êµ­ì±„ë¡œ ì™„ì „íˆ ì¶©ë‹¹ë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderSecLending() {
  // ëŒ€ì¶œ ìƒì„¸ì™€ í•©ì³ì§
}

function renderConsolidated() {
  const d = currentData;
  const isDetailed = localStorage.getItem('fed-detailed') !== 'false';
  
  const row = (kr, en, data, lvl=0, show=true) => {
    if (!show && !isDetailed) return '';
    const cls = lvl ? 'l'+lvl : '';
    return `<tr class="${cls}"><td><div class="bil"><span class="kr">${kr}</span><span class="en">${en}</span></div></td><td class="val">${fmt(data?.v)}</td><td class="chg ${chgClass(data?.w)}">${fmtChg(data?.w)}</td><td class="chg ${chgClass(data?.y)}">${fmtChg(data?.y)}</td></tr>`;
  };
  
  document.getElementById('consolidated').innerHTML = `
    <div class="view-toggle">
      <button class="toggle-btn ${isDetailed ? 'active' : ''}" onclick="setDetailedView(true)">ìƒì„¸</button>
      <button class="toggle-btn ${!isDetailed ? 'active' : ''}" onclick="setDetailedView(false)">ì¶•ì•½</button>
    </div>
    <div class="tbl-box">
      <h3>ì—°ê²° ì¬ë¬´ìƒíƒœí‘œ</h3>
      <p class="tbl-sub">Table 5: Consolidated Statement of Condition of All Federal Reserve Banks Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p>
      <div class="stmt-grid">
        <div class="stmt-sec">
          <h4>ìì‚° ASSETS</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ê¸ˆ ì¦ì„œ ê³„ì •','Gold Certificate Account',d.goldCertAccount || d.gold)}
              ${row('SDR ì¦ì„œ ê³„ì •','SDR Certificate Account',d.sdrCertAccount || d.sdr)}
              ${row('ì£¼í™”','Coin',d.coin,0,false)}
              ${row('ì¦ê¶Œ, í”„ë¦¬ë¯¸ì—„/í• ì¸, ë ˆí¬, ëŒ€ì¶œ','Securities, Premiums/Discounts, Repos, Loans',d.securitiesLoansTotal || d.securitiesHeld)}
              ${row('ë³´ìœ  ì¦ê¶Œ','Securities Held Outright',d.securitiesHeld,1)}
              ${row('ë¯¸ êµ­ì±„','U.S. Treasury Securities',d.treasurySecurities,2,false)}
              ${row('ë‹¨ê¸°ì±„','Bills',d.bills,2,false)}
              ${row('ì¤‘ì¥ê¸°ì±„ (ëª…ëª©)','Notes and Bonds, Nominal',d.notesAndBonds,2,false)}
              ${row('ë¬¼ê°€ì—°ë™ì±„','Notes and Bonds, Inflation-indexed',d.tips,2,false)}
              ${row('ì¸í”Œë ˆì´ì…˜ ë³´ì •','Inflation Compensation',d.inflationComp,2,false)}
              ${row('ì—°ë°©ê¸°ê´€ì±„','Federal Agency Debt Securities',d.agencyDebt,2,false)}
              ${row('MBS','Mortgage-Backed Securities',d.mbs,2)}
              ${row('ë¯¸ìƒê° í”„ë¦¬ë¯¸ì—„','Unamortized Premiums',d.unamortizedPremiums,1,false)}
              ${row('ë¯¸ìƒê° í• ì¸','Unamortized Discounts',d.unamortizedDiscounts,1,false)}
              ${row('ë ˆí¬','Repurchase Agreements',d.repos,1,false)}
              ${row('ëŒ€ì¶œ','Loans',d.loans,1)}
              ${row('ë©”ì¸ìŠ¤íŠ¸ë¦¬íŠ¸','MS Facilities (Main Street)',d.mainStreet,0,false)}
              ${row('ìˆ˜ê¸ˆ ì¤‘ í•­ëª©','Items in Process of Collection',d.itemsInCollection,0,false)}
              ${row('ì€í–‰ ê±´ë¬¼','Bank Premises',d.bankPremises,0,false)}
              ${row('í†µí™”ìŠ¤ì™‘','Central Bank Liquidity Swaps',d.swaps)}
              ${row('ì™¸í™”í‘œì‹œ ìì‚°','Foreign Currency Denominated Assets',d.foreignCurrency,0,false)}
              ${row('ê¸°íƒ€ ìì‚°','Other Assets',d.otherAssets,0,false)}
              <tr class="tot"><td><strong>ì´ ìì‚°</strong></td><td class="val"><strong>${fmt(d.totalAssets?.v || d.totalSupplying?.v)}</strong></td><td class="chg ${chgClass(d.totalAssets?.w || d.totalSupplying?.w)}"><strong>${fmtChg(d.totalAssets?.w || d.totalSupplying?.w)}</strong></td><td class="chg ${chgClass(d.totalAssets?.y || d.totalSupplying?.y)}"><strong>${fmtChg(d.totalAssets?.y || d.totalSupplying?.y)}</strong></td></tr>
            </tbody>
          </table>
        </div>
        <div class="stmt-sec">
          <h4>ë¶€ì±„ LIABILITIES</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ì—°ë°©ì¤€ë¹„ê¶Œ (ìˆœì•¡)','Federal Reserve Notes, Net',d.frNotesNet || d.currency)}
              ${row('ì—­ë ˆí¬','Reverse Repurchase Agreements',d.rrp)}
              ${row('ì™¸êµ­ ê³µì‹/êµ­ì œê¸°ê´€','Foreign Official and International',d.rrpForeign,1,false)}
              ${row('ê¸°íƒ€','Others',d.rrpOthers,1,false)}
              ${row('ì˜ˆê¸ˆ','Deposits',d.depositsTotal || d.deposits)}
              ${row('ì •ê¸°ì˜ˆê¸ˆ','Term Deposits',d.termDeposits,1,false)}
              ${row('ê¸°íƒ€ ì˜ˆê¸ˆê¸°ê´€','Other Deposits Held by Depository',d.otherDepositsDepository,1,false)}
              ${row('TGA','U.S. Treasury, General Account',d.tga,1)}
              ${row('ì™¸êµ­ ê³µì‹ê¸°ê´€','Foreign Official',d.foreignDeposits,1,false)}
              ${row('ê¸°íƒ€','Other',d.otherDeposits,1,false)}
              ${row('ì´ì—°ê°€ìš©í˜„ê¸ˆ','Deferred Availability Cash Items',d.deferredAvailability,0,false)}
              ${row('ì¬ë¬´ë¶€ ì¶œì','Treasury Contributions to Credit Facilities',d.treasuryContributions,0,false)}
              ${row('ê¸°íƒ€ ë¶€ì±„ ë° ë°°ë‹¹','Other Liabilities and Accrued Dividends',d.otherLiabilities,0,false)}
              <tr class="tot"><td><strong>ì´ ë¶€ì±„</strong></td><td class="val"><strong>${fmt(d.totalLiabilities?.v)}</strong></td><td class="chg ${chgClass(d.totalLiabilities?.w)}"><strong>${fmtChg(d.totalLiabilities?.w)}</strong></td><td class="chg ${chgClass(d.totalLiabilities?.y)}"><strong>${fmtChg(d.totalLiabilities?.y)}</strong></td></tr>
            </tbody>
          </table>
          <h4 style="margin-top:20px">ìë³¸ CAPITAL</h4>
          <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê°„ Î”</th><th>ì—°ê°„ Î”</th></tr></thead>
            <tbody>
              ${row('ë‚©ì… ìë³¸','Capital Paid In',d.capitalPaidIn)}
              ${row('ì‰ì—¬ê¸ˆ','Surplus',d.surplus)}
              ${row('ê¸°íƒ€ ìë³¸','Other Capital',d.otherCapital,0,false)}
              <tr class="tot"><td><strong>ì´ ìë³¸</strong></td><td class="val"><strong>${fmt(d.totalCapital?.v || ((d.capitalPaidIn?.v||0) + (d.surplus?.v||0)))}</strong></td><td></td><td></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

let selectedBankIdx = 0;

function getPrevBanks() {
  // í˜„ì¬ ë°ì´í„° ë‹¤ìŒ ì¸ë±ìŠ¤ì˜ ë°ì´í„° (ì‹œê°„ìˆœ ì´ì „ ë°ì´í„°)
  if (savedDataList.length > 1 && currentDataIndex < savedDataList.length - 1) {
    return savedDataList[currentDataIndex + 1]?.banks || [];
  }
  return [];
}

function renderBanks() {
  const banks = currentData.banks || [];
  const prevBanks = getPrevBanks();
  const maxA = Math.max(...banks.map(b => b.assets || 0), 1);
  const totalAllBanks = banks.reduce((sum, b) => sum + (b.assets || 0), 0);
  
  document.getElementById('banks').innerHTML = `
    <div class="tbl-box">
      <h3>ê° ì—°ë°©ì¤€ë¹„ì€í–‰</h3>
      <p class="tbl-sub">Statement of Each Federal Reserve Bank Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬ ${prevBanks.length ? 'Â· ì´ì „ ëŒ€ë¹„ ì¦ê° í‘œì‹œ' : ''}</p>
      
      <div class="bk-tabs">${banks.map((b, idx) => `
        <button class="bk-tab ${idx === selectedBankIdx ? 'active' : ''}" onclick="selectBank(${idx})">
          <span class="bk-tab-name">${b.kr}</span>
          <span class="bk-tab-val">$${(b.assets/1e6).toFixed(2)}T</span>
          <span class="bk-tab-pct">${((b.assets/totalAllBanks)*100).toFixed(1)}%</span>
        </button>
      `).join('')}</div>
      
      <div class="bk-detail-panel" id="bankDetailPanel">
        ${renderBankDetailTable(banks[selectedBankIdx], totalAllBanks, prevBanks[selectedBankIdx])}
      </div>
    </div>`;
}

function selectBank(idx) {
  selectedBankIdx = idx;
  const banks = currentData.banks || [];
  const prevBanks = getPrevBanks();
  const totalAllBanks = banks.reduce((sum, b) => sum + (b.assets || 0), 0);
  
  // íƒ­ í™œì„±í™” ì—…ë°ì´íŠ¸
  document.querySelectorAll('.bk-tab').forEach((tab, i) => {
    tab.classList.toggle('active', i === idx);
  });
  
  // ìƒì„¸ íŒ¨ë„ ì—…ë°ì´íŠ¸
  document.getElementById('bankDetailPanel').innerHTML = renderBankDetailTable(banks[idx], totalAllBanks, prevBanks[idx]);
}

function renderBankDetailTable(bank, totalAllBanks, prevBank) {
  if (!bank) return '<div class="bk-detail-empty">ë°ì´í„° ì—†ìŒ</div>';
  
  const pct = (v) => totalAllBanks ? ((v / totalAllBanks) * 100).toFixed(2) + '%' : '-';
  const chg = (curr, prev) => {
    if (!prev || prev === 0) return { val: '-', pct: '-', cls: '' };
    const diff = curr - prev;
    const pctChg = ((diff / prev) * 100).toFixed(2);
    const cls = diff > 0 ? 'pos' : diff < 0 ? 'neg' : '';
    return { 
      val: diff === 0 ? '-' : (diff > 0 ? '+' : '') + fmt(diff), 
      pct: diff === 0 ? '-' : (diff > 0 ? '+' : '') + pctChg + '%',
      cls 
    };
  };
  
  const row = (kr, en, key, isL1 = false) => {
    const curr = bank[key] || 0;
    const prev = prevBank ? (prevBank[key] || 0) : 0;
    const c = chg(curr, prev);
    return `<tr class="${isL1 ? 'l1' : ''}"><td><div class="bil"><span class="kr">${kr}</span><span class="en">${en}</span></div></td><td class="val">${fmt(curr)}</td><td class="chg ${c.cls}">${c.val}<br><small>${c.pct}</small></td></tr>`;
  };
  
  const assetsChg = chg(bank.assets, prevBank?.assets);
  
  return `
    <div class="bk-detail-header">
      <div class="bk-detail-name">
        <span class="bk-detail-kr">${bank.kr}</span>
        <span class="bk-detail-en">${bank.name} Federal Reserve Bank</span>
      </div>
      <div class="bk-detail-total">
        <span class="bk-detail-total-val">$${fmt(bank.assets)}M</span>
        <span class="bk-detail-total-pct">ì „ì²´ì˜ ${pct(bank.assets)}</span>
        ${prevBank ? `<span class="bk-detail-chg ${assetsChg.cls}">${assetsChg.val} (${assetsChg.pct})</span>` : ''}
      </div>
    </div>
    
    <div class="stmt-grid">
      <div class="stmt-sec">
        <h4>ìì‚° ASSETS</h4>
        <table>
          <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì¦ê°</th></tr></thead>
          <tbody>
            ${row('ê¸ˆ ì¦ì„œ', 'Gold Certificates', 'goldCerts')}
            ${row('SDR ì¦ì„œ', 'SDR Certificates', 'sdrCerts')}
            ${row('ë³´ìœ  ì¦ê¶Œ', 'Securities Held', 'securities')}
            ${row('ë¯¸ êµ­ì±„', 'Treasury Securities', 'treasuries', true)}
            ${row('MBS', 'Mortgage-Backed', 'mbs', true)}
            ${row('ë ˆí¬', 'Repurchase Agreements', 'repos')}
            ${row('ëŒ€ì¶œ', 'Loans', 'loans')}
            <tr class="tot"><td><strong>ì´ ìì‚°</strong></td><td class="val"><strong>${fmt(bank.assets)}</strong></td><td class="chg ${assetsChg.cls}"><strong>${assetsChg.val}</strong><br><small>${assetsChg.pct}</small></td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="stmt-sec">
        <h4>ë¶€ì±„ LIABILITIES</h4>
        <table>
          <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì¦ê°</th></tr></thead>
          <tbody>
            ${row('ì—°ë°©ì¤€ë¹„ê¶Œ', 'F.R. Notes Outstanding', 'frNotes')}
            ${row('ì—­ë ˆí¬', 'Reverse Repurchase', 'rrp')}
            ${row('ì˜ˆì¹˜ê¸ˆ', 'Deposits', 'deposits')}
            ${row('ë‚©ì… ìë³¸', 'Capital Paid In', 'capital')}
            ${row('ì‰ì—¬ê¸ˆ', 'Surplus', 'surplus')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderFRNotes() {
  const notes = currentData.frNotes || [];
  document.getElementById('frNotes').innerHTML = `<div class="tbl-box"><h3>ì—°ë°©ì¤€ë¹„ê¶Œ ë°œí–‰ ë° ë‹´ë³´</h3><p class="tbl-sub">Federal Reserve Notes Outstanding and Collateral Â· ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬</p><table><thead><tr><th>ì—°ë°©ì¤€ë¹„ì€í–‰</th><th>ë°œí–‰ì•¡</th><th>ë‹´ë³´</th><th>ê¸ˆ ì¦ì„œ</th></tr></thead><tbody>${notes.map(n => `<tr><td><div class="bil"><span class="kr">${n.kr}</span><span class="en">${n.name}</span></div></td><td class="val">${fmt(n.outstanding)}</td><td class="val">${fmt(n.collateral)}</td><td class="val">${fmt(n.gold)}</td></tr>`).join('')}</tbody></table></div><div class="info"><h4>ì—°ë°©ì¤€ë¹„ê¶Œ ë‹´ë³´ ìš”ê±´</h4><p style="color:var(--text2);line-height:1.6">ì—°ë°©ì¤€ë¹„ê¶Œ(ë¯¸êµ­ ë‹¬ëŸ¬ ì§€í)ì€ ë°œí–‰ì•¡ì˜ 100% ì´ìƒì„ ë‹´ë³´ë¡œ ë³´ìœ í•´ì•¼ í•©ë‹ˆë‹¤. ë‹´ë³´ëŠ” ì£¼ë¡œ ë¯¸êµ­ êµ­ì±„, MBS ë“± ì ê²© ì¦ê¶Œê³¼ ê¸ˆ ì¦ì„œë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.</p></div>`;
}

function renderCharts() {
  if (savedDataList.length < 2) {
    document.getElementById('charts').innerHTML = `<div class="no-data"><h3>ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</h3><p>ì¶”ì´ ì°¨íŠ¸ë¥¼ ë³´ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p><p style="margin-top:16px;color:var(--text3)">í˜„ì¬ ì €ì¥ëœ ë°ì´í„°: ${savedDataList.length}ê°œ</p></div>`;
    return;
  }
  const now = new Date();
  const periods = { '1m': 30, '3m': 90, '6m': 180, '1y': 365 };
  const days = periods[chartPeriod] || 90;
  const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
  let filtered = savedDataList.filter(d => parseDate(d.releaseDate) >= cutoff);
  if (filtered.length < 2) filtered = savedDataList.slice(0, Math.min(savedDataList.length, 12));
  filtered = filtered.reverse();
  const metrics = [{key:'totalSupplying',kr:'ì´ ìì‚°',en:'Total Assets'},{key:'reserves',kr:'ì§€ê¸‰ì¤€ë¹„ê¸ˆ',en:'Reserve Balances'},{key:'tga',kr:'TGA',en:'Treasury General Account'},{key:'rrp',kr:'ì—­ë ˆí¬',en:'Reverse Repo'},{key:'securitiesHeld',kr:'ë³´ìœ  ì¦ê¶Œ',en:'Securities Held'},{key:'currency',kr:'ìœ í†µ í†µí™”',en:'Currency'}];
  let html = `<div class="chart-controls"><label>ê¸°ê°„:</label><button class="period-btn ${chartPeriod==='1m'?'active':''}" onclick="setPeriod('1m')">1ê°œì›”</button><button class="period-btn ${chartPeriod==='3m'?'active':''}" onclick="setPeriod('3m')">3ê°œì›”</button><button class="period-btn ${chartPeriod==='6m'?'active':''}" onclick="setPeriod('6m')">6ê°œì›”</button><button class="period-btn ${chartPeriod==='1y'?'active':''}" onclick="setPeriod('1y')">1ë…„</button></div><div class="chart-grid">`;
  metrics.forEach(m => {
    const data = filtered.map(d => ({date:d.releaseDate,value:d[m.key]?.v||0})).filter(d => d.value > 0);
    if (data.length < 2) return;
    const values = data.map(d => d.value);
    const min = Math.min(...values), max = Math.max(...values), range = max - min || 1;
    const first = values[0], last = values[values.length - 1];
    const change = last - first, changePct = (change / first) * 100;
    const w = 360, h = 150, padL = 10, padR = 10, padT = 10, padB = 30;
    const chartW = w - padL - padR, chartH = h - padT - padB;
    const points = data.map((d, i) => ({x:padL+(i/(data.length-1))*chartW,y:padT+chartH-((d.value-min)/range)*chartH,...d}));
    const pathD = points.map((p, i) => `${i===0?'M':'L'} ${p.x} ${p.y}`).join(' ');
    const areaD = pathD + ` L ${points[points.length-1].x} ${h-padB} L ${padL} ${h-padB} Z`;
    html += `<div class="chart-card"><h4>${m.kr}</h4><div class="sub">${m.en}</div><div class="chart-stats"><div class="chart-stat"><div class="label">í˜„ì¬</div><div class="value">$${(last/1e6).toFixed(2)}T</div></div><div class="chart-stat"><div class="label">ë³€ë™</div><div class="change ${chgClass(change)}">${fmtChg(Math.round(change))} (${fmtPct(changePct)})</div></div></div><svg class="chart-svg" viewBox="0 0 ${w} ${h}"><path class="chart-area" d="${areaD}" /><path class="chart-line" d="${pathD}" />${points.map(p => `<circle class="chart-dot" cx="${p.x}" cy="${p.y}" r="4" />`).join('')}<text class="chart-label" x="${padL}" y="${h-8}">${data[0].date.split(',')[0]}</text><text class="chart-label" x="${w-padR}" y="${h-8}" text-anchor="end">${data[data.length-1].date.split(',')[0]}</text></svg></div>`;
  });
  html += '</div>';
  document.getElementById('charts').innerHTML = html;
}

function setPeriod(p) { chartPeriod = p; renderCharts(); }

async function fetchLatestH41() {
  const btn = document.getElementById('fetchBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> ë‹¤ìš´ë¡œë“œ ì¤‘...';
  
  try {
    const res = await fetch('/api/h41/fetch');
    const data = await res.json();
    
    if (data.error) {
      showToast('âŒ ' + data.error, 'error');
      return;
    }
    
    if (data.status === 'exists') {
      showToast('â„¹ï¸ ' + data.message);
    } else {
      showToast('âœ… ' + data.message);
    }
    
    // PDF íŒŒì¼ ê°€ì ¸ì™€ì„œ íŒŒì‹±
    if (data.filename) {
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> ë¶„ì„ ì¤‘...';
      
      const pdfRes = await fetch('/api/h41/file/' + encodeURIComponent(data.filename));
      const pdfBlob = await pdfRes.blob();
      const pdfFile = new File([pdfBlob], data.filename, { type: 'application/pdf' });
      
      await processSinglePDF(pdfFile);
      showToast('âœ… ë¶„ì„ ì™„ë£Œ!');
    }
  } catch (e) {
    console.error('Fetch H41 error:', e);
    showToast('âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// Claude AI ëª…ë ¹ ì²˜ë¦¬ (Fed í˜ì´ì§€ëŠ” ì¡°íšŒ ìœ„ì£¼)
function handleChatCommand(cmd) {
  showToast(cmd.message || 'ëª…ë ¹ ì²˜ë¦¬ë¨');
}

async function init() { 
  await loadSettingsFromServer(); 
  await loadDataFromServer();
  
  // Claude ì±„íŒ… ì´ˆê¸°í™”
  ChatWidget.init('fed', handleChatCommand);
}
init();
</script>
<script src="shared/chat.js"></script>
<style>
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.spin { animation: spin 1s linear infinite; }
</style>
</body>
</html>
